{% extends "store/base.html" %}
{% load static %}
{% load querystring from django_tables2 %}

{% block title %}
Add Product
{% endblock title %}

{% block content %}

<style>
    .processor-field,
    .ram-field,
    .hdd-field,
    .ssd-field {
        border: 1px solid #ccc;
        /* Light gray border */
        padding: 5px;
        border-radius: 5px;
        /* Optional: for rounded corners */
    }

    .processor-field input,
    .ram-field input,
    .hdd-field input,
    .ssd-field input {
        border: none;
        /* To avoid extra borders on input fields */
    }

    /* Increase width of individual form controls */
    .processor-field select,
    .ram-field select,
    .hdd-field select,
    .ssd-field select,
    .processor-field input,
    .ram-field input,
    .hdd-field input,
    .ssd-field input {
        width: 100%;
        /* Full width of the container */
    }

    /* Optionally, add padding for extra spacing */
    .processor-field input,
    .ram-field input,
    .hdd-field input,
    .ssd-field input {
        padding: 10px;
    }

    /* Optional: Set a max-width for responsiveness */
    .processor-field,
    .ram-field,
    .hdd-field,
    .ssd-field {
        max-width: 100%;
    }
</style>
<br>
<div class="container my-5">
    <!-- Go back -->
    <div class="mb-4">
        <a href="{% url 'productslist' %}" class="btn btn-outline-success">
            <i class="fas fa-arrow-left me-2"></i>
            Go back
        </a>
    </div>
    <div class="row justify-content-center">
        <!-- Excel Import Form -->
        <div class="card shadow-sm border-light w-100">
            <div class="card-body">
                <h5 class="card-title mb-3">Import Products from Excel</h5>
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                {% if success %}
                    <div class="alert alert-success">{{ success }}</div>
                {% endif %}

                <form method="POST" enctype="multipart/form-data" action="{% url 'upload_category_items' %}">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-4">
                            {{ form.file.label_tag }}
                            {{ form.file }}
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm rounded-pill shadow-sm"><i class="fa-solid fa-download"></i> Upload Product </button>
                </form>
            </div>
        </div>
        <div class="card shadow-sm border-light">
            <div class="card-body">
                {% if request.user.profile.role != 'OP' %}
                <form method="POST" enctype="multipart/form-data" action="{% url 'product-create' %}">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <!-- Product Name -->
                        <div class="col-md-4">
                            <label for="{{ form.name.id_for_label }}" class="form-label" placeholder="Enter Product Name">
                                Product Name
                            </label>
                            {{ form.name }}
                            <div class="text-danger">{{ form.name.errors }}</div>
                        </div>

                        <!-- Serial No -->
                        <div class="col-md-4">
                            <label for="id_serialno" class="form-label" placeholder="Enter Serial No">Serial No</label>
                            {{ form.serialno }}
                            <div class="text-danger">{{ form.serialno.errors }}</div>
                        </div>

                        <!-- Make & Models -->
                        <div class="col-md-4">
                            <label for="{{ form.make_and_models.id_for_label }}" class="form-label" >
                                Make & Models
                            </label>
                            <div aria-placeholder="Enter Make & Models"></div>
                            {{ form.make_and_models }}
                            <div class="text-danger">{{ form.make_and_models.errors }}</div>
                        </div>
                    </div>

                    <!-- Processor Section -->
                    <div class="row mb-3">
                        <!-- Processor Details (75% width) -->
                        <div class="col-md-9">
                            <label for="processor" class="form-label">Processor Details</label>
                            <input type="text" name="processor" id="processor" class="form-control" placeholder="Enter Processor Name. if more > 1 e.g. i5 8th Generation, i7 9th Generation"
                                style="text-transform: uppercase;">
                            <div class="text-danger">{{ form.processors.errors }}</div>   
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label for="processor_qty" class="form-label">Qty</label>
                            <input type="text" id="processor_qty" name="processor_qty" class="form-control"
                                value="{{ form.processor_qty.value }}" placeholder="e.g. 2,1">
                        </div> 

                    </div>

                    <!-- RAM Section -->
                    <div class="row mb-3">
                        <!-- RAM Details (75% width) -->
                        <div class="col-md-9">
                            <label for="ram" class="form-label">RAM Details</label>
                            
                            <input type="text" name="ram" id="ram" class="form-control" placeholder="Enter RAM details.  if more > 1 e.g. 4GB Company-name, 8GB Company-name"
                            style="text-transform: uppercase;">
                            
                            <div class="text-danger">{{ form.rams.errors }}</div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label for="ram_qty" class="form-label">Qty</label>
                            <input type="text" id="ram_qty" name="ram_qty" class="form-control"
                                value="{{ form.ram_qty.value }}" placeholder="e.g. 1,2">
                        </div>
                    </div>

                    <!-- HDD Section -->
                    <div class="row mb-3">
                        <!-- HDD Details (75% width) -->
                        <div class="col-md-9">
                            <label for="hdd" class="form-label">HDD Details</label>
                            <input type="text" name="hdd" id="hdd" class="form-control" placeholder="Enter HDD details.  if more > 1 e.g. 500GB Company-name, 1TB Company-name"
                            style="text-transform: uppercase;">
                            <div class="text-danger">{{ form.hdds.errors }}</div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label for="hdd_qty" class="form-label">Qty</label>
                            <input type="text" id="hdd_qty" name="hdd_qty" class="form-control"
                                value="{{ form.hdd_qty.value }}" placeholder="e.g. 1,2">
                        </div>
                    </div>

                    <!-- SSD Section -->
                    <div class="row mb-3">
                        <!-- SSD Details (75% width) -->
                        <div class="col-md-9">
                            <label for="ssd" class="form-label">SSD Details</label>
                            <input type="text" name="ssd" id="ssd" class="form-control" placeholder="Enter SSD details.  if more > 1 e.g. 256GB Company-name, 512GB Company-name"
                            style="text-transform: uppercase;">
                            <div class="text-danger">{{ form.ssds.errors }}</div>
                        </div>


                        <div class="col-md-6 col-lg-3">
                            <label for="ssd_qty" class="form-label">Qty</label>
                            <input type="text" id="ssd_qty" name="ssd_qty" class="form-control"
                                value="{{ form.ssd_qty.value }}" placeholder="e.g. 1,2">
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="quantity" class="form-label">Item Quantity</label>
                        <input type="number" id="quantity" name="quantity" class="form-control"
                            value="{{ form.quantity.value }}">
                    </div>

                    <!-- SMPS Section -->
                    <!-- <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="smps_status" class="form-label">SMPS Status</label>
                            {{ form.smps_status }}
                            <div class="text-danger">{{ form.smps_status.errors }}</div>
                        </div>
                        <div class="col-md-4" id="motherboard_status_div">
                            <label for="motherboard_status" class="form-label">Motherboard Status</label>
                            {{ form.motherboard_status }}
                            <div class="text-danger">{{ form.motherboard_status.errors }}</div>
                        </div>
                    </div> -->

                    <!-- <div class="row mb-3">
                        <div class="col-md-4" id="smps_replacement_description_div" style="display: none;">
                            <label for="smps_replacement_description" class="form-label">SMPS Replacement
                                Description</label>
                            <input type="text" id="smps_replacement_description" name="smps_replacement_description"
                                class="form-control">
                        </div>
                        <div class="col-md-4" id="motherboard_replacement_description_div" style="display: none;">
                            <label for="motherboard_replacement_description" class="form-label">Motherboard
                                Replacement Description</label>
                            <input type="text" id="motherboard_replacement_description"
                                name="motherboard_replacement_description" class="form-control">
                        </div>
                    </div> -->

                    <div class="form-group text-center">
                        <button class="btn btn-success btn-lg" type="submit">
                            <i class="fas fa-check"></i> Submit
                        </button>
                    </div>
                </form>
                {% else %}
                <h1 style="color: red; text-align: center;"><b>Sorry You Don't have Permission to Add Product</b></h1>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>

document.addEventListener('DOMContentLoaded', function () {
        const serialInput = document.getElementById("id_serialno");  // Django auto-generates this ID
        const processorSelect = document.getElementById("id_processors");
        const ramSelect = document.getElementById("id_rams");
        const hddSelect = document.getElementById("id_hdds");
        const ssdSelect = document.getElementById("id_ssds");
        const processorfilter = document.getElementById("Processor_Filter");
        const ssdfilter = document.getElementById("SSD_Filter");
        const ramfilter = document.getElementById("RAM_Filter");
        const hddfilter = document.getElementById("HDD_Filter");

        serialInput.addEventListener("change", function () {
            const serial = serialInput.value;

            if (serial.length >= 3) {
                fetch(`/get-category-items/?serial=${serial}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(processorSelect, data.processors);
                        updateSelectOptions(ramSelect, data.rams);
                        updateSelectOptions(hddSelect, data.hdds);
                        updateSelectOptions(ssdSelect, data.ssds);
                    });
            }
        });

        processorfilter.addEventListener("change", function () {
            const processorfltr = processorfilter.value;

            if (processorfltr.length >= 3) {
                fetch(`/get-category-items/?name=${processorfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(processorSelect, data.processors);
                    });
            }
        });

        

        ramfilter.addEventListener("change", function () {
            const ramfltr = ramfilter.value;

            if (ramfilter.length >= 3) {
                fetch(`/get-category-items/?name=${ramfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(ramSelect, data.rams);
                    });
            }
        });

        ssdfilter.addEventListener("change", function () {
            const ssdfltr = ssdfilter.value;

            if (ssdfilter.length >= 3) {
                fetch(`/get-category-items/?name=${ssdfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(ssdSelect, data.ssds);
                    });
            }
        });

        hddfilter.addEventListener("change", function () {
            const hddfltr = hddfilter.value;

            if (hddfilter.length >= 3) {
                fetch(`/get-category-items/?name=${hddfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(hddSelect, data.hdds);
                    });
            }
        });


        function updateSelectOptions(selectElement, items) {
            selectElement.innerHTML = "";  // Clear existing options
            items.forEach(item => {
                const option = document.createElement("option");
                option.value = item.id;
                option.textContent = `${item.name} - ${item.serial_no} (Qty: ${item.quantity})`;
                selectElement.appendChild(option);
            });
        }

    });

    document.getElementById("add-processor-btn").addEventListener("click", function() {
            window.location.href = "{% url 'category-create' %}";
        });

    // Toggle the replacement description fields
    function toggleReplacementDescription() {
        var smpsStatus = document.getElementById("smps_status").value;
        var replacementDescriptionDiv = document.getElementById("smps_replacement_description_div");
        replacementDescriptionDiv.style.display = smpsStatus === "replacement" ? "block" : "none";
    }
    function toggleMotherboardReplacementDescription() {
        var motherboardStatus = document.getElementById("motherboard_status").value;
        var toggleMotherboardReplacementDescriptionDiv = document.getElementById("motherboard_replacement_description_div");
        toggleMotherboardReplacementDescriptionDiv.style.display = motherboardStatus === "replacement" ? "block" : "none";
    }

    function searchSuggestions(inputId, suggestionsId) {
        const searchBox = document.getElementById(inputId);
        const suggestionsBox = document.getElementById(suggestionsId);

        searchBox.addEventListener('input', function () {
            const query = searchBox.value;
            if (query.length >= 2) { // trigger after at least 2 characters
                fetch(`/search-suggestions/?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsBox.innerHTML = ''; // Clear previous suggestions
                        if (data.suggestions.length > 0) {
                            data.suggestions.forEach(suggestion => {
                                const item = document.createElement('a');
                                item.href = "javascript:void(0);"; // Prevent immediate navigation
                                item.classList.add('list-group-item', 'list-group-item-action');
                                item.textContent = suggestion;
                                item.addEventListener('click', function () {
                                    searchBox.value = suggestion; // Fill input with clicked suggestion
                                    suggestionsBox.innerHTML = ''; // Hide suggestions
                                });
                                suggestionsBox.appendChild(item);
                            });
                        } else {
                            const noResultsItem = document.createElement('a');
                            noResultsItem.classList.add('list-group-item', 'list-group-item-action', 'text-danger');
                            noResultsItem.textContent = 'No suggestions found! Click here to add item';
                            noResultsItem.style.cursor = 'pointer'; // Make it look clickable
                            noResultsItem.addEventListener('click', function () {
                                window.location.href = "{% url 'category-create' %}"; // Redirect to add item form
                            });
                            suggestionsBox.appendChild(noResultsItem);
                        }
                    })
                    .catch(error => console.error('Error fetching suggestions:', error));
            } else {
                suggestionsBox.innerHTML = ''; // Clear suggestions if input is less than 2 characters
            }
        });
    }

    //     document.addEventListener('DOMContentLoaded', function() {
    //     var showButton = document.getElementById('show-processor-button');
    //     var processorFieldContainer = document.getElementById('processors-field');
    //     var serialnoFieldId = "{{ form.serialno.id_for_label }}";
    //     var serialNoInput = document.getElementById(serialnoFieldId);

    //     showButton.addEventListener('click', function() {
    //         var serialNo = serialNoInput.value.trim();

    //         if (serialNo) {
    //             // Make the AJAX request to fetch processors based on serialno
    //             fetch(`/add-processor1/?serialno=${serialNo}`)
    //                 .then(response => response.json())
    //                 .then(data => {
    //                     // Get the form processors field
    //                     var processorsField = document.getElementById('{{ form.processors.id_for_label }}');

    //                     // Check if we got processors in the response
    //                     if (data.success && data.processors.length > 0) {
    //                         // Clear any previous options or content
    //                         processorsField.innerHTML = ''; 

    //                         // Optionally, add a default option
    //                         var defaultOption = document.createElement('option');
    //                         defaultOption.value = '';
    //                         defaultOption.textContent = 'Select a processor';
    //                         processorsField.appendChild(defaultOption);

    //                         // Add processors to the dropdown or select field
    //                         data.processors.forEach(processor => {
    //                             var option = document.createElement('option');
    //                             option.value = processor.id; // Assuming processor.id is what should be selected
    //                             option.textContent = `Processor Name: ${processor.name} (Quantity: ${processor.quantity})`;
    //                             processorsField.appendChild(option);
    //                         });

    //                         processorFieldContainer.style.display = 'block'; // Show the processor field
    //                     } else {
    //                         // If no processors are found, show a default "No processors" option
    //                         processorsField.innerHTML = '<option>No processors found for this serial number.</option>';
    //                         processorFieldContainer.style.display = 'block'; // Show the processor field
    //                     }
    //                 })
    //                 .catch(error => {
    //                     console.error('Error fetching processors:', error);
    //                 });
    //         } else {
    //             alert('Please enter a serial number.');
    //         }
    //     });
    // });

    document.getElementById("add-processor-btn").addEventListener("click", function () {
        document.getElementById("add-processor-form").style.display = "block";
    });

    document.getElementById("processor-create-form").addEventListener("submit", function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        fetch("{% url 'create_processor' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const selectField = document.querySelector("#processors-field select");
                    const option = document.createElement("option");
                    option.value = data.processor.id;
                    option.text = data.processor.name;
                    option.selected = true;
                    selectField.appendChild(option);
                    document.getElementById("processors-field").style.display = "block";
                    form.reset();
                    document.getElementById("add-processor-form").style.display = "none";
                } else {
                    alert("Failed to add processor");
                }
            });
    });

    // Initialize search suggestions for each input field (Processor, RAM, HDD, SSD)
    searchSuggestions('searchbox', 'suggestions');
    searchSuggestions('searchbox1', 'suggestions1');
    searchSuggestions('searchbox2', 'suggestions2');
    searchSuggestions('searchbox3', 'suggestions3');
</script>

{% endblock content %}