{% extends "store/base.html" %}
{% load static %}
{% load querystring from django_tables2 %}

{% block title %}
Add Product
{% endblock title %}

{% block content %}

<style>
    .processor-field,
    .ram-field,
    .hdd-field,
    .ssd-field {
        border: 1px solid #ccc;
        /* Light gray border */
        padding: 5px;
        border-radius: 5px;
        /* Optional: for rounded corners */
    }

    .processor-field input,
    .ram-field input,
    .hdd-field input,
    .ssd-field input {
        border: none;
        /* To avoid extra borders on input fields */
    }

    /* Increase width of individual form controls */
    .processor-field select,
    .ram-field select,
    .hdd-field select,
    .ssd-field select,
    .processor-field input,
    .ram-field input,
    .hdd-field input,
    .ssd-field input {
        width: 100%;
        /* Full width of the container */
    }

    /* Optionally, add padding for extra spacing */
    .processor-field input,
    .ram-field input,
    .hdd-field input,
    .ssd-field input {
        padding: 10px;
    }

    /* Optional: Set a max-width for responsiveness */
    .processor-field,
    .ram-field,
    .hdd-field,
    .ssd-field {
        max-width: 100%;
    }
</style>
<style>
    #customer_suggestions {
        max-height: 200px;
        overflow-y: auto;
        background-color: white;
        border: 1px solid #ccc;
        border-radius: 4px;
    }
</style>

<br>
<div class="container my-5">
    <!-- Go back -->
    <div class="mb-4">
        <a href="{% url 'productslist' %}" class="btn btn-outline-success">
            <i class="fas fa-arrow-left me-2"></i>
            Go back
        </a>
    </div>
    <div class="row justify-content-center">
        <!-- Excel Import Form -->
        <div class="card shadow-sm border-light w-100">
            <div class="card-body">
                <h5 class="card-title mb-3">Import Products from Excel</h5>
                {% if error %}
                    <div class="alert alert-danger">{{ error }}</div>
                {% endif %}
                {% if success %}
                    <div class="alert alert-success">{{ success }}</div>
                {% endif %}

                <form method="POST" enctype="multipart/form-data" action="{% url 'upload_category_items' %}">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <div class="col-md-4">
                            {{ form.file.label_tag }}
                            {{ form.file }}
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success btn-sm rounded-pill shadow-sm"><i class="fa-solid fa-download"></i> Upload Product </button>
                </form>
            </div>
        </div>
        <div class="card shadow-sm border-light">
            <div class="card-body">
                {% if request.user.profile.role != 'OP' %}
                <form method="POST" enctype="multipart/form-data" action="{% url 'product-create' %}">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <!-- Product Name -->
                        <div class="col-md-4">
                            <label for="{{ form.name.id_for_label }}" class="form-label" placeholder="Enter Product Name">
                                Product Name
                            </label>
                            {{ form.name }}
                            <div class="text-danger">{{ form.name.errors }}</div>
                        </div>

                        <!-- Serial No -->
                        <div class="col-md-4">
                            <label for="id_serialno" class="form-label" placeholder="Enter Serial No">Serial No</label>
                            {{ form.serialno }}
                            <div class="text-danger">{{ form.serialno.errors }}</div>
                        </div>

                        <!-- Make & Models -->
                        <div class="col-md-4">
                            <label for="{{ form.make_and_models.id_for_label }}" class="form-label" >
                                Make & Models
                            </label>
                            <div aria-placeholder="Enter Make & Models"></div>
                            {{ form.make_and_models }}
                            <div class="text-danger">{{ form.make_and_models.errors }}</div>
                        </div>
                    </div>

                    <!-- Processor Section -->
                    <div class="row mb-3">
                        <!-- Processor Details (75% width) -->
                        <div class="col-md-9">
                            <label for="processor" class="form-label">Processor Details</label>
                            <input type="text" name="processor" id="processor" class="form-control" placeholder="Enter Processor Name. if more > 1 e.g. i5 8th Generation, i7 9th Generation"
                                style="text-transform: uppercase;">
                            <div class="text-danger">{{ form.processors.errors }}</div>   
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label for="processor_qty" class="form-label">Qty</label>
                            <input type="text" id="processor_qty" name="processor_qty" class="form-control"
                                value="{{ form.processor_qty.value }}" placeholder="e.g. 2,1">
                        </div> 

                    </div>

                    <!-- RAM Section -->
                    <div class="row mb-3">
                        <!-- RAM Details (75% width) -->
                        <div class="col-md-9">
                            <label for="ram" class="form-label">RAM Details</label>
                            
                            <input type="text" name="ram" id="ram" class="form-control" placeholder="Enter RAM details.  if more > 1 e.g. 4GB Company-name, 8GB Company-name"
                            style="text-transform: uppercase;">
                            
                            <div class="text-danger">{{ form.rams.errors }}</div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label for="ram_qty" class="form-label">Qty</label>
                            <input type="text" id="ram_qty" name="ram_qty" class="form-control"
                                value="{{ form.ram_qty.value }}" placeholder="e.g. 1,2">
                        </div>
                    </div>

                    <!-- HDD Section -->
                    <div class="row mb-3">
                        <!-- HDD Details (75% width) -->
                        <div class="col-md-9">
                            <label for="hdd" class="form-label">HDD Details</label>
                            <input type="text" name="hdd" id="hdd" class="form-control" placeholder="Enter HDD details.  if more > 1 e.g. 500GB Company-name, 1TB Company-name"
                            style="text-transform: uppercase;">
                            <div class="text-danger">{{ form.hdds.errors }}</div>
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label for="hdd_qty" class="form-label">Qty</label>
                            <input type="text" id="hdd_qty" name="hdd_qty" class="form-control"
                                value="{{ form.hdd_qty.value }}" placeholder="e.g. 1,2">
                        </div>
                    </div>

                    <!-- SSD Section -->
                    <div class="row mb-3">
                        <!-- SSD Details (75% width) -->
                        <div class="col-md-9">
                            <label for="ssd" class="form-label">SSD Details</label>
                            <input type="text" name="ssd" id="ssd" class="form-control" placeholder="Enter SSD details.  if more > 1 e.g. 256GB Company-name, 512GB Company-name"
                            style="text-transform: uppercase;">
                            <div class="text-danger">{{ form.ssds.errors }}</div>
                        </div>


                        <div class="col-md-6 col-lg-3">
                            <label for="ssd_qty" class="form-label">Qty</label>
                            <input type="text" id="ssd_qty" name="ssd_qty" class="form-control"
                                value="{{ form.ssd_qty.value }}" placeholder="e.g. 1,2">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="{{ form.price.id_for_label }}" class="form-label">
                                Price
                            </label>
                            {{ form.price }}
                            <div class="text-danger">{{ form.price.errors }}</div>
                        </div>

                        <div class="col-md-4">
                            <label for="{{ form.purchased_code.id_for_label }}" class="form-label" placeholder="Enter Purchase / LOT Code">
                                Purchase / LOT Code
                            </label>
                            {{ form.purchased_code }}
                            <div class="text-danger">{{ form.purchased_code.errors }}</div>
                        </div>

                        <div class="col-md-4">
                            <label for="customer_searchbox" class="form-label">Customer Name</label>
                            <input type="text" id="customer_searchbox" class="form-control" placeholder="Type Customer Name / Phone ... " autocomplete="off">
                            <div id="customer_suggestions" class="form-label" style="z-index: 1000;"></div>
                            <input type="hidden" name="customer_id" id="customer_id">  <!-- Hidden field to submit ID -->
                        </div>

                        
                    </div>


                    
                    <div class="row mb-3">
                        <!-- SMPS Section -->
                        <div class="col-md-4">
                            <label for="id_smps_status" class="form-label">SMPS / Adapter Status</label>
                            <select name="smps_status" id="id_smps_status" class="form-control">
                                <option value="NA" selected>NA</option>
                                <option value="available">Available</option>
                                <option value="not_available">Not Available</option>
                                <!-- <option value="replacement">Replacement</option> -->
                            </select>
                            <div class="text-danger">{{ form.smps_status.errors }}</div>
                        </div>
                        <!-- Motherboard Section -->
                        <div class="col-md-4">
                            <label for="id_motherboard_status" class="form-label">Motherboard Status</label>
                            <select name="motherboard_status" id="id_motherboard_status" class="form-control">
                                <option value="NA" selected>NA</option>
                                <option value="available">Available</option>
                                <option value="not_available">Not Available</option>
                                <!-- <option value="replacement">Replacement</option> -->
                            </select>
                            <div class="text-danger">{{ form.motherboard_status.errors }}</div>
                        </div>  
                    </div>

                    <!-- Note Section -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="note" class="form-label">Note</label>
                            <textarea name="note" id="note" class="form-control" rows="3" 
                                placeholder="Enter any additional notes about the item"></textarea>
                        </div>
                    </div>

                    <div class="form-group text-center">
                        <button class="btn btn-success btn-lg" type="submit">
                            <i class="fas fa-check"></i> Submit
                        </button>
                    </div>
                </form>
                {% else %}
                <h1 style="color: red; text-align: center;"><b>Sorry You Don't have Permission to Add Product</b></h1>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Customer Create Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="createCustomerForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <select name="person_type" id="person_type" class="form-control">
                            <option value="" disabled selected style="color: blue;">-- Select Person Type --</option>
                            <option value="customer">Customer</option>
                            <option value="vendor">Vendor</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <input type="text" name="first_name" class="form-control" placeholder="Enter First Name">
                    </div>
                    <div class="mb-3">
                        <input type="text" name="last_name" class="form-control" placeholder="Enter Last Name">
                    </div>
                    <div class="mb-3">
                        <input type="number" name="phone" class="form-control" placeholder="Enter Phone Number">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>

document.addEventListener('DOMContentLoaded', function () {
        const serialInput = document.getElementById("id_serialno");  // Django auto-generates this ID
        const processorSelect = document.getElementById("id_processors");
        const ramSelect = document.getElementById("id_rams");
        const hddSelect = document.getElementById("id_hdds");
        const ssdSelect = document.getElementById("id_ssds");
        const processorfilter = document.getElementById("Processor_Filter");
        const ssdfilter = document.getElementById("SSD_Filter");
        const ramfilter = document.getElementById("RAM_Filter");
        const hddfilter = document.getElementById("HDD_Filter");

        serialInput.addEventListener("change", function () {
            const serial = serialInput.value;

            if (serial.length >= 3) {
                fetch(`/get-category-items/?serial=${serial}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(processorSelect, data.processors);
                        updateSelectOptions(ramSelect, data.rams);
                        updateSelectOptions(hddSelect, data.hdds);
                        updateSelectOptions(ssdSelect, data.ssds);
                    });
            }
        });

        processorfilter.addEventListener("change", function () {
            const processorfltr = processorfilter.value;

            if (processorfltr.length >= 3) {
                fetch(`/get-category-items/?name=${processorfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(processorSelect, data.processors);
                    });
            }
        });

        

        ramfilter.addEventListener("change", function () {
            const ramfltr = ramfilter.value;

            if (ramfilter.length >= 3) {
                fetch(`/get-category-items/?name=${ramfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(ramSelect, data.rams);
                    });
            }
        });

        ssdfilter.addEventListener("change", function () {
            const ssdfltr = ssdfilter.value;

            if (ssdfilter.length >= 3) {
                fetch(`/get-category-items/?name=${ssdfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(ssdSelect, data.ssds);
                    });
            }
        });

        hddfilter.addEventListener("change", function () {
            const hddfltr = hddfilter.value;

            if (hddfilter.length >= 3) {
                fetch(`/get-category-items/?name=${hddfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(hddSelect, data.hdds);
                    });
            }
        });


        function updateSelectOptions(selectElement, items) {
            selectElement.innerHTML = "";  // Clear existing options
            items.forEach(item => {
                const option = document.createElement("option");
                option.value = item.id;
                option.textContent = `${item.name} - ${item.serial_no} (Qty: ${item.quantity})`;
                selectElement.appendChild(option);
            });
        }

    });

    document.getElementById("add-processor-btn").addEventListener("click", function() {
            window.location.href = "{% url 'category-create' %}";
        });

    // Add event listeners for SMPS and Motherboard status toggles
    document.addEventListener('DOMContentLoaded', function() {
        const smpsSelect = document.getElementById("smps_status");
        const motherboardSelect = document.getElementById("motherboard_status");
        
        // Add change event listeners
        smpsSelect.addEventListener('change', function() {
            const smpsReplacementDiv = document.getElementById("smps_replacement_description_div");
            smpsReplacementDiv.style.display = this.value === "replacement" ? "block" : "none";
        });
        
        motherboardSelect.addEventListener('change', function() {
            const motherboardReplacementDiv = document.getElementById("motherboard_replacement_description_div");
            motherboardReplacementDiv.style.display = this.value === "replacement" ? "block" : "none";
        });
        
        // Set initial state
        const smpsReplacementDiv = document.getElementById("smps_replacement_description_div");
        smpsReplacementDiv.style.display = smpsSelect.value === "replacement" ? "block" : "none";
        
        const motherboardReplacementDiv = document.getElementById("motherboard_replacement_description_div");
        motherboardReplacementDiv.style.display = motherboardSelect.value === "replacement" ? "block" : "none";
    });

    function searchSuggestions(inputId, suggestionsId) {
        const searchBox = document.getElementById(inputId);
        const suggestionsBox = document.getElementById(suggestionsId);

        searchBox.addEventListener('input', function () {
            const query = searchBox.value;
            if (query.length >= 2) { // trigger after at least 2 characters
                fetch(`/search-suggestions/?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsBox.innerHTML = ''; // Clear previous suggestions
                        if (data.suggestions.length > 0) {
                            data.suggestions.forEach(suggestion => {
                                const item = document.createElement('a');
                                item.href = "javascript:void(0);"; // Prevent immediate navigation
                                item.classList.add('list-group-item', 'list-group-item-action');
                                item.textContent = suggestion;
                                item.addEventListener('click', function () {
                                    searchBox.value = suggestion; // Fill input with clicked suggestion
                                    suggestionsBox.innerHTML = ''; // Hide suggestions
                                });
                                suggestionsBox.appendChild(item);
                            });
                        } else {
                            const noResultsItem = document.createElement('a');
                            noResultsItem.classList.add('list-group-item', 'list-group-item-action', 'text-danger');
                            noResultsItem.textContent = 'No suggestions found! Click here to add item';
                            noResultsItem.style.cursor = 'pointer'; // Make it look clickable
                            noResultsItem.addEventListener('click', function () {
                                window.location.href = "{% url 'category-create' %}"; // Redirect to add item form
                            });
                            suggestionsBox.appendChild(noResultsItem);
                        }
                    })
                    .catch(error => console.error('Error fetching suggestions:', error));
            } else {
                suggestionsBox.innerHTML = ''; // Clear suggestions if input is less than 2 characters
            }
        });
    }
    document.getElementById("add-processor-btn").addEventListener("click", function () {
        document.getElementById("add-processor-form").style.display = "block";
    });

    document.getElementById("processor-create-form").addEventListener("submit", function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        fetch("{% url 'create_processor' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const selectField = document.querySelector("#processors-field select");
                    const option = document.createElement("option");
                    option.value = data.processor.id;
                    option.text = data.processor.name;
                    option.selected = true;
                    selectField.appendChild(option);
                    document.getElementById("processors-field").style.display = "block";
                    form.reset();
                    document.getElementById("add-processor-form").style.display = "none";
                } else {
                    alert("Failed to add processor");
                }
            });
    });

    // Initialize search suggestions for each input field (Processor, RAM, HDD, SSD)
    searchSuggestions('searchbox', 'suggestions');
    searchSuggestions('searchbox1', 'suggestions1');
    searchSuggestions('searchbox2', 'suggestions2');
    searchSuggestions('searchbox3', 'suggestions3');
</script>

<script>
    function customerSearchSuggestions() {
        const searchBox = document.getElementById('customer_searchbox');
        const suggestionsBox = document.getElementById('customer_suggestions');
        const hiddenField = document.getElementById('customer_id');
        const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));

        searchBox.addEventListener('input', function () {
            const query = searchBox.value;
            if (query.length >= 2) {
                fetch(`/search-customer/?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data.results && data.results.length > 0) {
                            data.results.forEach(suggestion => {
                                const item = document.createElement('a');
                                item.href = 'javascript:void(0);';
                                item.classList.add('list-group-item', 'list-group-item-action');
                                item.textContent = suggestion.text;

                                item.addEventListener('click', function () {
                                    searchBox.value = suggestion.text;
                                    hiddenField.value = suggestion.id;
                                    suggestionsBox.innerHTML = '';
                                });

                                suggestionsBox.appendChild(item);
                            });
                        } else {
                            const noItem = document.createElement('a');
                            noItem.classList.add('list-group-item', 'list-group-item-action', 'text-danger');
                            noItem.textContent = 'No customer found. Click to add.';
                            noItem.style.cursor = 'pointer';
                            noItem.addEventListener('click', function () {
                                // Show the modal instead of redirecting
                                customerModal.show();
                                // Pre-fill the name if it exists in the search box
                                const searchValue = searchBox.value.trim();
                                if (searchValue) {
                                    const names = searchValue.split(' ');
                                    document.querySelector('#customerModal input[name="first_name"]').value = names[0] || '';
                                    document.querySelector('#customerModal input[name="last_name"]').value = names.slice(1).join(' ') || '';
                                }
                            });
                            suggestionsBox.appendChild(noItem);
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching customer suggestions:', err);
                    });
            } else {
                suggestionsBox.innerHTML = '';
                hiddenField.value = '';
            }
        });

        // Handle customer form submission
        document.getElementById('createCustomerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch("{% url 'create_customer_ajax' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the customer search box and hidden field with new customer data
                    searchBox.value = data.customer.full_name;
                    hiddenField.value = data.customer.id;
                    
                    // Close the modal and clear the form
                    customerModal.hide();
                    document.getElementById('createCustomerForm').reset();
                    
                    // Clear suggestions box
                    suggestionsBox.innerHTML = '';
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success';
                    alertDiv.textContent = 'Customer created successfully!';
                    document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('form'));
                    
                    // Remove alert after 3 seconds
                    setTimeout(() => alertDiv.remove(), 3000);
                } else {
                    // Show error message
                    alert(data.error || 'Error creating customer');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating customer');
            });
        });
    }

// Call it
customerSearchSuggestions();

</script>

{% endblock content %}