{% extends "store/base.html" %}
{% load static %}

{% block title %}
Add Product
{% endblock title %}

{% block content %}

<style>
    .processor-field,
    .ram-field,
    .hdd-field,
    .ssd-field {
        border: 1px solid #ccc;
        /* Light gray border */
        padding: 5px;
        border-radius: 5px;
        /* Optional: for rounded corners */
    }

    .processor-field input,
    .ram-field input,
    .hdd-field input,
    .ssd-field input {
        border: none;
        /* To avoid extra borders on input fields */
    }

    /* Increase width of individual form controls */
    .processor-field select,
    .ram-field select,
    .hdd-field select,
    .ssd-field select,
    .processor-field input,
    .ram-field input,
    .hdd-field input,
    .ssd-field input {
        width: 100%;
        /* Full width of the container */
    }

    /* Optionally, add padding for extra spacing */
    .processor-field input,
    .ram-field input,
    .hdd-field input,
    .ssd-field input {
        padding: 10px;
    }

    /* Optional: Set a max-width for responsiveness */
    .processor-field,
    .ram-field,
    .hdd-field,
    .ssd-field {
        max-width: 100%;
    }
</style>
<br>
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="card shadow-sm border-light">
            <div class="card-body">
                {% if request.user.profile.role != 'OP' %}
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <div class="row mb-3">
                        <!-- Product Name -->
                        <div class="col-md-4">
                            <label for="{{ form.name.id_for_label }}" class="form-label" placeholder="Enter Product Name">
                                Product Name
                            </label>
                            {{ form.name }}
                            <div class="text-danger">{{ form.name.errors }}</div>
                        </div>

                        <!-- Serial No -->
                        <div class="col-md-4">
                            <label for="id_serialno" class="form-label" placeholder="Enter Serial No">Serial No</label>
                            {{ form.serialno }}
                            <div class="text-danger">{{ form.serialno.errors }}</div>
                        </div>

                        <!-- Make & Models -->
                        <div class="col-md-4">
                            <label for="{{ form.make_and_models.id_for_label }}" class="form-label" >
                                Make & Models
                            </label>
                            <div aria-placeholder="Enter Make & Models"></div>
                            {{ form.make_and_models }}
                            <div class="text-danger">{{ form.make_and_models.errors }}</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <!-- Processor Details -->
                        <div class="col-md-9">
                            <label for="processor" class="form-label">Processor Details</label>
                            <input type="text" name="processor" id="processor" class="form-control"
                                value="{{ processor_option3|join:', ' }}"
                                placeholder="e.g. i5 8th Generation, i7 9th Generation" style="text-transform: uppercase;">
                            <div class="text-danger">{{ form.processor.errors }}</div>
                        </div>
                    
                        <!-- Processor Quantity -->
                        <div class="col-md-3">
                            <label for="processor_qty" class="form-label">Qty</label>
                            <input type="text" id="processor_qty" name="processor_qty" class="form-control"
                            value="{{ processor_qty3|join:', ' }}" placeholder="e.g. 2,1">
                            <div class="text-danger">{{ form.processor_qty.errors }}</div>
                        </div>
                    </div>
                    

                    <!-- ðŸ§  RAM Section -->
                    <div class="row mb-3">
                        <div class="col-md-9">
                            <label for="ram" class="form-label">RAM</label>
                            <input type="text" name="ram" id="ram" class="form-control"
                            value="{{ ram_option3|join:', ' }}" placeholder="e.g. 4GB Kingston, 8GB Samsung" style="text-transform: uppercase;">
                            <div class="text-danger">{{ form.ram.errors }}</div>
                        </div>
                        <div class="col-md-3">
                            <label for="ram_qty" class="form-label">Qty</label>
                            <input type="text" name="ram_qty" id="ram_qty" class="form-control mt-2"
                                value="{{ ram_qty3|join:', ' }}" placeholder="e.g. 1,2">
                            <div class="text-danger">{{ form.ram_qty.errors }}</div>
                        </div>
                    </div>

                    <!-- ðŸ’¾ HDD Section -->
                    <div class="row mb-3">
                        <div class="col-md-9">
                            <label for="hdd" class="form-label">HDD</label>
                            <input type="text" name="hdd" id="hdd" class="form-control"
                                value="{{ hdd_option3|join:', ' }}" placeholder="e.g. 500GB WD, 1TB Seagate" style="text-transform: uppercase;">
                            <div class="text-danger">{{ form.hdd.errors }}</div>
                        </div>
                        <div class="col-md-3">
                            <label for="hdd_qty" class="form-label">Qty</label>
                            <input type="text" name="hdd_qty" id="hdd_qty" class="form-control mt-2"
                                value="{{ hdd_qty3|join:', ' }}" placeholder="e.g. 1,1">
                            <div class="text-danger">{{ form.hdd_qty.errors }}</div>
                        </div>
                    </div>

                    <!-- âš¡ SSD Section -->
                    <div class="row mb-3">
                        <div class="col-md-9">
                            <label for="ssd" class="form-label">SSD</label>
                            <input type="text" name="ssd" id="ssd" class="form-control"
                                value="{{ ssd_option3|join:', ' }}" placeholder="e.g. 256GB Samsung, 512GB Kingston" style="text-transform: uppercase;">
                            <div class="text-danger">{{ form.ssd.errors }}</div>
                        </div>
                        <div class="col-md-3">
                            <label for="ssd_qty" class="form-label">Qty</label>
                            <input type="text" name="ssd_qty" id="ssd_qty" class="form-control mt-2"
                                value="{{ ssd_qty3|join:', ' }}" placeholder="e.g. 1,2">
                            <div class="text-danger">{{ form.ssd_qty.errors }}</div>
                        </div>
                    </div>


                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="{{ form.price.id_for_label }}" class="form-label">
                                Price
                            </label>
                            {{ form.price }}
                            <div class="text-danger">{{ form.price.errors }}</div>
                        </div>

                        <div class="col-md-4">
                            <label for="{{ form.purchased_code.id_for_label }}" class="form-label" placeholder="Enter Purchase / LOT Code">
                                Purchase / LOT Code
                            </label>
                            {{ form.purchased_code }}
                            <div class="text-danger">{{ form.purchased_code.errors }}</div>
                        </div>

                        <div class="col-md-4">
                            <label for="customer_searchbox" class="form-label">Customer Name</label>
                            <input type="text" id="customer_searchbox" class="form-control" placeholder="Type to search customer..." autocomplete="off" value="{{ form.instance.customer.get_full_name }}">
                            <div id="customer_suggestions" class="form-label" style="z-index: 1000;"></div>
                            <input type="hidden" name="customer_id" id="customer_id" value="{{ form.instance.customer.id }}">  <!-- Hidden field to submit ID -->
                        </div>
                    </div>


                    <!-- SMPS Section -->
                    <div class="row mb-3">
                        <!-- SMPS Status -->
                        <div class="col-md-4">
                            <label for="id_smps_status" class="form-label">SMPS Status</label>
                            <select name="smps_status" id="id_smps_status" class="form-control">
                                <option value="">Select Status</option>
                                <option value="NA" {% if form.instance.smps_status == 'NA' %}selected{% endif %}>NA</option>
                                <option value="available" {% if form.instance.smps_status == 'available' %}selected{% endif %}>Available</option>
                                <option value="not_available" {% if form.instance.smps_status == 'not_available' %}selected{% endif %}>Not Available</option>
                                <!-- <option value="replacement" {% if form.instance.smps_status == 'replacement' %}selected{% endif %}>Replacement</option> -->
                            </select>
                            <div class="text-danger">{{ form.smps_status.errors }}</div>
                        </div>

                        <!-- Motherboard Status -->
                        <div class="col-md-4">
                            <label for="id_motherboard_status" class="form-label">Motherboard Status</label>
                            <select name="motherboard_status" id="id_motherboard_status" class="form-control">
                                <option value="">Select Status</option>
                                <option value="NA" {% if form.instance.motherboard_status == 'NA' %}selected{% endif %}>NA</option>
                                <option value="available" {% if form.instance.motherboard_status == 'available' %}selected{% endif %}>Available</option>
                                <option value="not_available" {% if form.instance.motherboard_status == 'not_available' %}selected{% endif %}>Not Available</option>
                                <!-- <option value="replacement" {% if form.instance.motherboard_status == 'replacement' %}selected{% endif %}>Replacement</option> -->
                            </select>
                            <div class="text-danger">{{ form.motherboard_status.errors }}</div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <!-- SMPS Replacement Description -->
                        <div class="col-md-4" id="smps_replacement_description_div" style="display: none;">
                            <label for="smps_replacement_description" class="form-label">SMPS Replacement
                                Description</label>
                            <input type="text" id="smps_replacement_description" name="smps_replacement_description"
                                class="form-control" value="{{ form.instance.smps_replacement_description }}">
                        </div>

                        <!-- Motherboard Replacement Description -->
                        <div class="col-md-4" id="motherboard_replacement_description_div" style="display: none;">
                            <label for="motherboard_replacement_description" class="form-label">Motherboard
                                Replacement Description</label>
                            <input type="text" id="motherboard_replacement_description"
                                name="motherboard_replacement_description" class="form-control" 
                                value="{{ form.instance.motherboard_replacement_description }}">
                        </div>
                    </div>

                    <div class="form-group text-center">
                        <button class="btn btn-success btn-lg" type="submit">
                            <i class="fas fa-check"></i> Submit
                        </button>
                    </div>
                </form>
                {% else %}
                <h1 style="color: red; text-align: center;"><b>Sorry You Don't have Permission to Add Product</b></h1>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>

document.addEventListener('DOMContentLoaded', function () {
        // Set up SMPS and Motherboard status change handlers
        const smpsStatus = document.getElementById("id_smps_status");
        const motherboardStatus = document.getElementById("id_motherboard_status");
        const customerSearchBox = document.getElementById("customer_searchbox");
        const customerId = document.getElementById("customer_id");
        
        // Initialize customer if already set
        if (customerSearchBox.value && !customerId.value) {
            // If we have a name but no ID, try to fetch the customer ID
            fetch(`/search-customer/?q=${encodeURIComponent(customerSearchBox.value)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.suggestions && data.suggestions.length > 0) {
                        // Find exact match
                        const match = data.suggestions.find(s => s.name === customerSearchBox.value);
                        if (match) {
                            customerId.value = match.id;
                        }
                    }
                });
        }
        
        smpsStatus.addEventListener('change', toggleReplacementDescription);
        motherboardStatus.addEventListener('change', toggleMotherboardReplacementDescription);
        
        // Initial trigger of display logic
        toggleReplacementDescription();
        toggleMotherboardReplacementDescription();
        
        const serialInput = document.getElementById("id_serialno");  // Django auto-generates this ID
        const processorSelect = document.getElementById("processor");
        const ramSelect = document.getElementById("ram");
        const hddSelect = document.getElementById("hdd");
        const ssdSelect = document.getElementById("ssd");
        
        const processorfilter = document.getElementById("Processor_Filter");
        const ssdfilter = document.getElementById("SSD_Filter");
        const ramfilter = document.getElementById("RAM_Filter");
        const hddfilter = document.getElementById("HDD_Filter");

        serialInput.addEventListener("change", function () {
            const serial = serialInput.value;

            if (serial.length >= 3) {
                fetch(`/get-category-items/?serial=${serial}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(processorSelect, data.processors);
                        updateSelectOptions(ramSelect, data.rams);
                        updateSelectOptions(hddSelect, data.hdds);
                        updateSelectOptions(ssdSelect, data.ssds);
                    });
            }
        });

        processorfilter.addEventListener("change", function () {
            const processorfltr = processorfilter.value;

            if (processorfltr.length >= 3) {
                fetch(`/get-category-items/?name=${processorfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(processorSelect, data.processors);
                    });
            }
        });

        

        ramfilter.addEventListener("change", function () {
            const ramfltr = ramfilter.value;

            if (ramfilter.length >= 3) {
                fetch(`/get-category-items/?name=${ramfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(ramSelect, data.rams);
                    });
            }
        });

        ssdfilter.addEventListener("change", function () {
            const ssdfltr = ssdfilter.value;

            if (ssdfilter.length >= 3) {
                fetch(`/get-category-items/?name=${ssdfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(ssdSelect, data.ssds);
                    });
            }
        });

        hddfilter.addEventListener("change", function () {
            const hddfltr = hddfilter.value;

            if (hddfilter.length >= 3) {
                fetch(`/get-category-items/?name=${hddfltr}`)
                    .then(response => response.json())
                    .then(data => {
                        updateSelectOptions(hddSelect, data.hdds);
                    });
            }
        });


        function updateSelectOptions(selectElement, items) {
            selectElement.innerHTML = '<option value="">-- Select --</option>';
        if (!items || items.length === 0) {
            selectElement.innerHTML += '<option value="">No items available</option>';
        } else {
            items.forEach(item => {
                const option = document.createElement("option");
                option.value = item.id;
                option.textContent = `${item.name} - ${item.serial_no} (Qty: ${item.quantity})`;
                selectElement.appendChild(option);
            });
        }
    }

    });

    document.getElementById("add-processor-btn").addEventListener("click", function() {
            window.location.href = "{% url 'category-create' %}";
        });

    // Toggle the replacement description fields
    function toggleReplacementDescription() {
        var smpsStatus = document.getElementById("smps_status").value;
        var replacementDescriptionDiv = document.getElementById("smps_replacement_description_div");
        replacementDescriptionDiv.style.display = smpsStatus === "replacement" ? "block" : "none";
    }
    function toggleMotherboardReplacementDescription() {
        var motherboardStatus = document.getElementById("motherboard_status").value;
        var toggleMotherboardReplacementDescriptionDiv = document.getElementById("motherboard_replacement_description_div");
        toggleMotherboardReplacementDescriptionDiv.style.display = motherboardStatus === "replacement" ? "block" : "none";
    }

    function searchSuggestions(inputId, suggestionsId) {
        const searchBox = document.getElementById(inputId);
        const suggestionsBox = document.getElementById(suggestionsId);

        searchBox.addEventListener('input', function () {
            const query = searchBox.value;
            if (query.length >= 2) { // trigger after at least 2 characters
                fetch(`/search-suggestions/?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsBox.innerHTML = ''; // Clear previous suggestions
                        if (data.suggestions.length > 0) {
                            data.suggestions.forEach(suggestion => {
                                const item = document.createElement('a');
                                item.href = "javascript:void(0);"; // Prevent immediate navigation
                                item.classList.add('list-group-item', 'list-group-item-action');
                                item.textContent = suggestion;
                                item.addEventListener('click', function () {
                                    searchBox.value = suggestion; // Fill input with clicked suggestion
                                    suggestionsBox.innerHTML = ''; // Hide suggestions
                                });
                                suggestionsBox.appendChild(item);
                            });
                        } else {
                            const noResultsItem = document.createElement('a');
                            noResultsItem.classList.add('list-group-item', 'list-group-item-action', 'text-danger');
                            noResultsItem.textContent = 'No suggestions found! Click here to add item';
                            noResultsItem.style.cursor = 'pointer'; // Make it look clickable
                            noResultsItem.addEventListener('click', function () {
                                window.location.href = "{% url 'category-create' %}"; // Redirect to add item form
                            });
                            suggestionsBox.appendChild(noResultsItem);
                        }
                    })
                    .catch(error => console.error('Error fetching suggestions:', error));
            } else {
                suggestionsBox.innerHTML = ''; // Clear suggestions if input is less than 2 characters
            }
        });
    }

    //     document.addEventListener('DOMContentLoaded', function() {
    //     var showButton = document.getElementById('show-processor-button');
    //     var processorFieldContainer = document.getElementById('processors-field');
    //     var serialnoFieldId = "{{ form.serialno.id_for_label }}";
    //     var serialNoInput = document.getElementById(serialnoFieldId);

    //     showButton.addEventListener('click', function() {
    //         var serialNo = serialNoInput.value.trim();

    //         if (serialNo) {
    //             // Make the AJAX request to fetch processors based on serialno
    //             fetch(`/add-processor1/?serialno=${serialNo}`)
    //                 .then(response => response.json())
    //                 .then(data => {
    //                     // Get the form processors field
    //                     var processorsField = document.getElementById('{{ form.processors.id_for_label }}');

    //                     // Check if we got processors in the response
    //                     if (data.success && data.processors.length > 0) {
    //                         // Clear any previous options or content
    //                         processorsField.innerHTML = ''; 

    //                         // Optionally, add a default option
    //                         var defaultOption = document.createElement('option');
    //                         defaultOption.value = '';
    //                         defaultOption.textContent = 'Select a processor';
    //                         processorsField.appendChild(defaultOption);

    //                         // Add processors to the dropdown or select field
    //                         data.processors.forEach(processor => {
    //                             var option = document.createElement('option');
    //                             option.value = processor.id; // Assuming processor.id is what should be selected
    //                             option.textContent = `Processor Name: ${processor.name} (Quantity: ${processor.quantity})`;
    //                             processorsField.appendChild(option);
    //                         });

    //                         processorFieldContainer.style.display = 'block'; // Show the processor field
    //                     } else {
    //                         // If no processors are found, show a default "No processors" option
    //                         processorsField.innerHTML = '<option>No processors found for this serial number.</option>';
    //                         processorFieldContainer.style.display = 'block'; // Show the processor field
    //                     }
    //                 })
    //                 .catch(error => {
    //                     console.error('Error fetching processors:', error);
    //                 });
    //         } else {
    //             alert('Please enter a serial number.');
    //         }
    //     });
    // });

    document.getElementById("add-processor-btn").addEventListener("click", function () {
        document.getElementById("add-processor-form").style.display = "block";
    });

    document.getElementById("processor-create-form").addEventListener("submit", function (e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        fetch("{% url 'create_processor' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": formData.get("csrfmiddlewaretoken")
            },
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const selectField = document.querySelector("#processors-field select");
                    const option = document.createElement("option");
                    option.value = data.processor.id;
                    option.text = data.processor.name;
                    option.selected = true;
                    selectField.appendChild(option);
                    document.getElementById("processors-field").style.display = "block";
                    form.reset();
                    document.getElementById("add-processor-form").style.display = "none";
                } else {
                    alert("Failed to add processor");
                }
            });
    });

    // Initialize search suggestions for each input field (Processor, RAM, HDD, SSD)
    searchSuggestions('searchbox', 'suggestions');
    searchSuggestions('searchbox1', 'suggestions1');
    searchSuggestions('searchbox2', 'suggestions2');
    searchSuggestions('searchbox3', 'suggestions3');
</script>

<!-- Customer Create Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="createCustomerForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="person_type" class="form-label">Person Type</label>
                        <select name="person_type" id="person_type" class="form-control">
                            <option value="customer">Customer</option>
                            <option value="vendor">Vendor</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <input type="text" name="first_name" class="form-control" placeholder="Enter First Name">
                    </div>
                    <div class="mb-3">
                        <input type="text" name="last_name" class="form-control" placeholder="Enter Last Name">
                    </div>
                    <div class="mb-3">
                        <input type="number" name="phone" class="form-control" placeholder="Enter Phone Number">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script>
function customerSearchSuggestions() {
    const searchBox = document.getElementById('customer_searchbox');
    const suggestionsBox = document.getElementById('customer_suggestions');
    const hiddenField = document.getElementById('customer_id');
    const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));

    searchBox.addEventListener('input', function () {
        const query = searchBox.value;
        if (query.length >= 2) {
            fetch(`/search-customer/?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    suggestionsBox.innerHTML = '';
                    if (data.suggestions.length > 0) {
                        data.suggestions.forEach(suggestion => {
                            const item = document.createElement('a');
                            item.href = 'javascript:void(0);';
                            item.classList.add('list-group-item', 'list-group-item-action');
                            item.textContent = suggestion.name;

                            item.addEventListener('click', function () {
                                searchBox.value = suggestion.name;
                                hiddenField.value = suggestion.id;
                                suggestionsBox.innerHTML = '';
                            });

                            suggestionsBox.appendChild(item);
                        });
                    } else {
                        const noItem = document.createElement('a');
                        noItem.classList.add('list-group-item', 'list-group-item-action', 'text-danger');
                        noItem.textContent = 'No customer found. Click to add.';
                        noItem.style.cursor = 'pointer';
                        noItem.addEventListener('click', function () {
                            customerModal.show();
                            const searchValue = searchBox.value.trim();
                            if (searchValue) {
                                const names = searchValue.split(' ');
                                document.querySelector('#customerModal input[name="first_name"]').value = names[0] || '';
                                document.querySelector('#customerModal input[name="last_name"]').value = names.slice(1).join(' ') || '';
                            }
                        });
                        suggestionsBox.appendChild(noItem);
                    }
                })
                .catch(err => {
                    console.error('Error fetching customer suggestions:', err);
                });
        } else {
            suggestionsBox.innerHTML = '';
            hiddenField.value = '';
        }
    });

    // Handle customer form submission
    document.getElementById('createCustomerForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        // Get the person type value
        const personType = document.getElementById('person_type').value;
        formData.append('person_type', personType);
        
        fetch("{% url 'create_customer_ajax' %}", {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the customer search box and hidden field with new customer data
                searchBox.value = data.customer.name;
                hiddenField.value = data.customer.id;
                
                // Close the modal and clear the form
                customerModal.hide();
                document.getElementById('createCustomerForm').reset();
                
                // Clear suggestions box
                suggestionsBox.innerHTML = '';
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success';
                alertDiv.textContent = 'Customer created successfully!';
                document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('form'));
                
                // Remove alert after 3 seconds
                setTimeout(() => alertDiv.remove(), 3000);
            } else {
                // Show error message
                alert(data.error || 'Error creating customer');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error creating customer');
        });
    });
}

// Call it
customerSearchSuggestions();
</script>

{% endblock content %}