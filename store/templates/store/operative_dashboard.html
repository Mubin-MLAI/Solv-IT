{% extends "store/base.html" %}
{% load static %}
{% load querystring from django_tables2 %}

{% block title %}Products{% endblock title %}

{% block content %}

<style>
    /* Global Dark Theme */
    body {
        background: #0d1117 !important;
        color: #e6edf3 !important;
        font-family: "Inter", sans-serif;
    }

    h4.display-6 {
        color: #2196f3 !important; /* neon green */
        font-weight: 700;
    }

    /* Search Box */
    .search-dark {
        background: #161b22;
        border: 1px solid #30363d;
        color: #e6edf3;
        height: 48px;
        border-radius: 50px;
        padding-left: 18px;
        box-shadow: 0 0 5px rgba(76,175,80,0.2);
    }

    .search-dark:focus {
        background: #0d1117;
        border-color: #2196f3;
        color: white !important;
        box-shadow: 0 0 6px #2196f3;
    }

    .suggestions {
        background: #161b22;
        border: 1px solid #30363d;
        border-radius: 10px;
        color: white;
    }

    .suggestions .list-group-item {
        background: #161b22;
        color: #e6edf3;
        border: none;
    }

    .suggestions .list-group-item:hover {
        background: #21262d !important;
    }

    .table-container {
    width: 100%;
    background: #161b22;
    border-radius: 16px;
    overflow-x: auto;
    border: 1px solid #30363d;
}

    /* Table Styling */
    .table-dark-custom {
        background: #161b22;
        color: #e6edf3;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #30363d;
        box-shadow: 0px 0px 15px rgba(50,255,120,0.05);
    }

    .table-dark-custom thead {
        background: #1f2937;
        color: #2196f3;
        font-weight: bold;
    }

    .table-dark-custom tbody tr {
        transition: 0.2s;
    }

    .table-dark-custom tbody tr:hover {
        background: #21262d !important;
    }

    .table-dark-custom td, 
    .table-dark-custom th {
        border-color: #30363d;
    }

    /* Buttons */
    .btn-dark-green {
        border-radius: 30px;
        padding: 6px 16px;
        border-color: #2196f3 !important;
        color: #2196f3 !important;
        font-weight: 600;
        transition: 0.3s;
    }

    .btn-dark-green:hover {
        background: #2196f3 !important;
        color: #0d1117 !important;
    }

    .btn-outline-danger:hover {
        background: #ef4444 !important;
        color: white;
    }

    /* Pagination */
    .pagination .page-link {
        background: #161b22;
        border: 1px solid #30363d;
        color: #e6edf3;
    }

    .pagination .active .page-link {
        background: #2196f3 !important;
        color: #0d1117 !important;
        border-color: #2196f3 !important;
        font-weight: bold;
    }

</style>

<br>

<div class="my-4">
    <div class="row align-items-center">
        <div class="col-md-6">
            <h4 class="display-6 mb-0">Products List</h4>
        </div>
    </div>

    <!-- Search Box -->
    <form class="input-group mt-3 position-relative" id="searchform1"
        action="{% url 'item_search_list_view' %}" method="get">
        <input id="searchbox1" name="q" type="text"
            class="form-control search-dark shadow-sm"
            placeholder="Search products...">

        <button class="btn btn-dark-green" type="submit">
            <i class="fa-solid fa-search"></i>
        </button>
    </form>

    <div id="suggestions1"
        class="list-group position-absolute suggestions mt-1"
        style="z-index:9999; width:100%;">
    </div>
</div>

<!-- Product Table -->
<div class="px-2">

    {% if items %}
    <div class="table-responsive mt-4">
        <table class="table-container table-dark-custom table-hover table-sm">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Serial No</th>
                    <th>Make & Models</th>
                    <th>Processor</th>
                    <th>RAM</th>
                    <th>HDD</th>
                    <th>SSD</th>
                    <th>SMPS</th>
                    <th>Motherboard</th>
                    <th>Actions</th>
                </tr>
            </thead>

            <tbody>
                {% for item in items %}
                <tr>
                    <th>{{ item.id }}</th>
                    <td>{{ item.name }}</td>
                    <td>{{ item.serialno }}</td>
                    <td>{{ item.make_and_models }}</td>

                    <td>{% for p in item.processors %}<li>{{ p }}</li>{% endfor %}</td>
                    <td>{% for p in item.rams %}<li>{{ p }}</li>{% endfor %}</td>
                    <td>{% for p in item.hdds %}<li>{{ p }}</li>{% endfor %}</td>
                    <td>{% for p in item.ssds %}<li>{{ p }}</li>{% endfor %}</td>

                    <td>{{ item.smps_status }}</td>
                    <td>{{ item.motherboard_status }}</td>

                    <td>
                        <div class="d-flex gap-2">
                            <a class="btn btn-dark-green btn-sm"
                                href="{% url 'product-update' item.slug %}">
                                <i class="fa-solid fa-pen"></i>
                            </a>
                            <!-- <a class="btn btn-outline-danger btn-sm"
                                href="{% url 'product-delete' item.slug %}">
                                <i class="fa-solid fa-trash"></i>
                            </a> -->
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}
</div>

<!-- Success Messages -->
<div class="card-body mt-3">
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-success text-center" role="alert"
            style="font-size: large;">
            {{ message }}
        </div>
        {% endfor %}
    {% endif %}
</div>

<!-- Pagination -->
{% if is_paginated %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center mt-4">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                &laquo;
            </a>
        </li>
        {% endif %}

        {% for i in paginator.page_range %}
            {% if page_obj.number == i %}
            <li class="page-item active">
                <span class="page-link">{{ i }}</span>
            </li>
            {% else %}
            <li class="page-item">
                <a class="page-link" href="?page={{ i }}">{{ i }}</a>
            </li>
            {% endif %}
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                &raquo;
            </a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<!-- Search Suggestions Script -->
<script>
    const searchBox = document.getElementById('searchbox1');
    const suggestionsBox = document.getElementById('suggestions1');

    searchBox.addEventListener('input', function () {
        const query = searchBox.value;
        if (query.length >= 2) {
            fetch(`/search-suggestions-product/?q=${query}`)
                .then(r => r.json())
                .then(data => {
                    suggestionsBox.innerHTML = "";
                    if (data.suggestions.length > 0) {
                        data.suggestions.forEach(s => {
                            let a = document.createElement("a");
                            a.classList.add("list-group-item");
                            a.textContent = s;
                            a.onclick = () => { searchBox.value = s; suggestionsBox.innerHTML = ""; };
                            suggestionsBox.appendChild(a);
                        });
                    } else {
                        let noItem = document.createElement("a");
                        noItem.classList.add("list-group-item", "text-danger");
                        noItem.textContent = "No results! Click to add item";
                        noItem.onclick = () => window.location.href = "{% url 'product-create' %}";
                        suggestionsBox.appendChild(noItem);
                    }
                });
        } else {
            suggestionsBox.innerHTML = "";
        }
    });

    document.addEventListener('click', (e) => {
        if (!searchBox.contains(e.target) && !suggestionsBox.contains(e.target)) {
            suggestionsBox.innerHTML = "";
        }
    });
</script>

{% endblock content %}
