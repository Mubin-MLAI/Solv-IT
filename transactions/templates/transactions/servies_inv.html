{% extends "store/base.html" %} 
{% load static %}
{% block title %}Transaction detail{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 4 -->
  <!-- <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"> -->

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Roboto, sans-serif;
      background: #f8f9fa;
      -webkit-print-color-adjust: exact !important;
      print-color-adjust: exact !important;
    }

    /* Wrapper for responsive + print */
    #invoice-wrapper {
      width: 800px;
      max-width: 100%;
      margin-left: auto;
      margin-right: auto;
      background: white;
      padding: 15px;
      box-sizing: border-box;
      display: block;
    }

    /* Center for PDF/print */
    @media print {
      #invoice-wrapper {
        width: 210mm;
        margin-left: auto;
        margin-right: auto;
        padding: 20mm;
        background: white;
      }
    }

    /* A4 print settings */
    @media print {
      #invoice-wrapper {
        width: 210mm;
        padding: 20mm;
      }
      #downloadBtn {
        display: none !important;
      }
    }

    .invoice-letter {
      background-color: #04617B;
      color: #fff;
      padding: 1rem;
      border-radius: 0.5rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    table.invoice thead th {
      background-color: rgba(4, 97, 123, 0.2);
    }

    tr.last-row {
      background-color: rgba(4, 97, 123, 0.2);
    }

    .effect-color {
      color: rgb(249, 99, 50);
    }

    .theme-color {
      color: rgb(198, 89, 99);
    }

    .footer-signature {
      margin-top: 40px;
      padding-top: 40px;
      padding-bottom: 60px;
      border-top: 1px solid #ccc;
      text-align: center;
    }

    .signature-block {
      padding-top: 40px;
      padding-bottom: 40px;
    }

    .signature-line {
      /* border-top: 0px solid #000; */
      width: 180px;
      /* margin: 0 auto 1.5rem auto; */
      height: 3.5rem;
      display: block;
    }
  </style>
  <div class="mb-4 form-control-sm">
        <a href="{% url 'saleslist' %}" class="btn btn-outline-success">
            <i class="fas fa-arrow-left me-2"></i>
            Back to sales list
        </a>
    </div>
</head>
<body>
  <div id="invoice-wrapper" class="container-fluid">
    
    <!-- HEADER -->
    <div class="row align-items-center mb-10">
      <div class="col text-center">
  <img src="/static/images/logo/solvit-logo.jpg" class="img-fluid" style="max-width: 70%; height: auto;" alt="Solv-IT Logo" />
      </div>
    </div>

    <div class="row align-items-center mb-10">
      <div class="col text-center">
        <h3><strong>SERVICE BILL</strong></h3>
      </div>  
    </div>

    <div class="invoice-letter mb-10">
        <h5 style="color: #fff; font-weight: bold;">
            Invoice No. SERINV-{{ servicebill.id }} <br>
            Date: {{ servicebill.date_created|date:"d/m/Y" }}
        </h5>
    </div>

    <!-- CUSTOMER + TOTAL -->
    <div class="row">
    <div class="col-md-6 mb-10">
        <h5 class="effect-color">Invoiced to:</h5>
        <h4 class="theme-color"><strong>{{ servicebill.customer.first_name }} {{ servicebill.customer.last_name }}</strong></h4>
        <p>{{ servicebill.customer.address }}</p>
        <p>{{ servicebill.customer.phone }}</p>
        <p><strong>GSTIN:</strong> {{ servicebill.customer.gstin }}</p>
    </div>
    <div class="col-md-6">
        <table class="table table-sm table-borderless">
        <tbody>
            <tr>
            <th>Subtotal</th>
            <td>₹{{ servicebill.total_amount|floatformat:2 }}</td>
            </tr>
            <tr>
            <th>GST (%)</th>
            <td>{{ servicebill.total_tax|floatformat:2 }}</td>
            </tr>
        </tbody>
        <tfoot>
            <tr class="font-weight-bold">
            <th>Grand Total</th>
            <td>₹{{ servicebill.grand_total|floatformat:2 }}</td>
            </tr>
            <tr>
            <th>Payment Status</th>
            <td>{{ servicebill.status }}</td>
            </tr>
            <tr>
            <th>Balance</th>
            <td>₹ {{ balance|floatformat:2 }}</td>
            </tr>
        </tfoot>
        </table>
    </div>
    </div>

    <!-- ITEM TABLE -->
    <div class="table-responsive mt-5">
    <table class="table table-bordered table-sm invoice ">
        <thead>
        <tr>
            <th>No.</th>
            <th>Item</th>
            <th>Description</th>
            <th>Qty</th>
            <th>Amount</th>
            <th>Tax %</th>
            <th>Tax Amt</th>
            <th>Total</th>
        </tr>
        </thead>
        <tbody>
          {% for item in items %}
          <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ item.item_name }}</td>
              <td>{{ item.description }}</td>
              <td>{{ item.qty }}</td>
              <td>{{ item.amount }}</td>
              <td>{{ item.tax_percent }}</td>
              <td>{{ item.tax_amt }}</td>
              <td>{{ item.total }}</td>
          </tr>
          {% endfor %}
      </tbody>
    </table>
    </div>

    <!-- SIGNATURE -->
    <div class="footer-signature row text-center">
      <div class="col-md-6 mb-10">
        <div class="signature-line"></div>
        <p>Company Signature</p>
      </div>
      <div class="col-md-6 mb-3">
        <div class="signature-line"></div>
        <p>Client Signature</p>
      </div>
    </div>
  </div>
  <div class="text-center my-4">
    <button id="downloadBtn" class="btn btn-primary">Download PDF</button>
  </div>

  <!-- JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script>
    document.getElementById("downloadBtn").addEventListener("click", function () {
      const element = document.getElementById("invoice-wrapper");
      const now = new Date();
      const pad = (n) => n.toString().padStart(2, '0');
      const formattedDate = `${pad(now.getDate())}-${pad(now.getMonth() + 1)}-${now.getFullYear()}_${pad(now.getHours())}-${pad(now.getMinutes())}`;
      const invoiceNo = "SERINV-{{ servicebill.id }}";
      const filename = `${invoiceNo}_${formattedDate}.pdf`;

      const opt = {
        margin: 0,
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'], avoid: '.avoid-break', before: '.page-break' }
      };

      html2pdf().set(opt).from(element).save();
    });
  </script>
</body>
</html>
{% endblock %}
