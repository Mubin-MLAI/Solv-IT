{% extends "store/base.html" %} {% load static %}{% block title %}Transaction detail{% endblock %}
{% block content %}


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 4 -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">

  <style>
    @page {
      size: A4;
      margin: 0;
    }

    body {
	  margin: 0;
	  padding: 0;
	  font-family: Roboto, sans-serif;
	  background: white;
	  -webkit-print-color-adjust: exact !important;
	}

	.container {
	  width: 210mm;  /* A4 width */
	  min-height: 297mm; /* A4 height */
	  padding: 20mm;
	  box-sizing: border-box;
	  background: white;
	  border-radius: 0;
	  box-shadow: none;
	}


    .invoice-letter {
      width: auto;
      position: relative;
      min-height: 150px;
      background-color: #04617B;
      margin-left: -3rem;
      margin-right: -3rem;
      box-shadow: 0 4px 3px rgba(0,0,0,0.4);
    }

    table.invoice thead th {
      background-color: rgba(4, 97, 123, 0.2);
      border-top: none;
    }

    table.invoice thead tr:first-child th:first-child {
      border-top-left-radius: 25px;
    }

    table.invoice thead tr:first-child th:last-child {
      border-top-right-radius: 25px;
    }

    tr.last-row {
      background-color: rgba(4, 97, 123, 0.2);
    }

    tr.last-row th {
      border-bottom-left-radius: 25px;
    }

    tr.last-row td {
      border-bottom-right-radius: 25px;
    }

    div.to {
      height: 260px;
      padding-right: 25px;
      border-right: 2px solid rgba(4, 97, 123, 0.2);
    }

    .effect-color {
      color: rgb(249, 99, 50);
    }

    .theme-color {
      color: rgb(198, 89, 99);
    }

    .footer-signature {
      margin-top: 3rem;
      border-top: 1px solid #ccc;
      padding-top: 1rem;
    }

    .signature-block {
      text-align: center;
      padding-top: 2rem;
    }

    .signature-line {
      border-top: 1px solid #000;
      width: 200px;
      margin: 0 auto 0.5rem auto;
    }

    @media print {
      #downloadBtn {
        display: none;
      }
    }
  </style>
</head>
<body>

<div id="invoice" class="container my-3 px-5 py-5">
  <!-- HEADER SECTION -->
  <div class="row">
    <!-- <div class="col-3 contact-details">
      <h5><b>Solv-IT</b></h5>
      <h6><em>Shop no 3&4, Kulsum Heritage,Sector 12-E,KoparKhairane, Navi Mumbai, Mah-400709</em></h6>
      <p><em>Phone:+91 922-296-6631</em></p>
    </div> -->
    <div class="col text-center logo">
      <img src="/static/images/logo/solvit1.png" style="max-width: 50%; height: auto;" alt="Solv-IT Logo" />
    </div>   
    <!-- <div class="invoice-details col-3 offset-2 text-right">
      <h6>Invoice No. INV{{ sale.id }}</h6>
      <h6>Date : {{ sale.date_added|date:"d/m/Y H:i:s" }}</h6>
    </div> -->
  </div>

  <!-- LETTER HEADER -->
  <div class="container-fluid invoice-letter mt-2 text-white">
    <div class="row">
      <div class="col-3 pl-5 py-4 letter-title">
        <h6 style="color: rgb(254, 251, 251);">
          <b>
          Invoice No. INV{{ sale.id }}
          Date : {{ sale.date_added|date:"d/m/Y" }}
          </b>
        </h6>
      </div>
      <div class="col-9 pr-5 py-2 letter-content">
        <h6 style="color: white;">
          <em><b>Address:</b> Shop No 3&4, Kulsum Heritage, opposite Animal Quarantine and Certification Centre, Sector 12-E, Bonkode, KoparKhairane, Navi Mumbai, Maharashtra - 400709</em>
        </h6>        
        <p><em><b>Phone:</b> +91 922-296-6631</em></p>
        
      </div>
    </div>
  </div>

  <!-- INVOICE TABLE -->
  <div class="row table mt-5">
    <table class="invoice table table-hover">
      <thead>
        <tr>
          <th>NO.</th>
          <th>Item</th>
          <th>Qty.</th>
          <th>Price</th>
          <th>GST</th>
          <th>Amount</th>
        </tr>
      </thead>
      <tbody>
        {% for detail in sale.saledetail_set.all %}
        <tr>
          <th>{{ forloop.counter }}</th>
          <td>
            <strong>{{ detail.item.name }} ({{ detail.item.serialno }})</strong><br>
            {{ detail.description|safe }}
          </td>          
          <td>{{ detail.quantity }}</td>
          <td>{{ sale.sub_total }} <span class="currency">&#8377;</span></td>
          <td>{{ sale.tax_amount }} <span class="currency">&#8377;</span></td>
          <td>{{ sale.grand_total }} <span class="currency">&#8377;</span></td>
        </tr>
        {% endfor %}
        <!-- <tr>
          <th>2</th>
          <td>Really, really long item title</td>
          <td>1</td>
          <td>25 <span class="currency">&euro;</span></td>
          <td></td>
          <td>28,75 <span class="currency">&euro;</span></td>
        </tr>
        <tr>
          <th>3</th>
          <td>Lorem ipsum dolor sit amet, consectetur adipiscing elit.</td>
          <td>1</td>
          <td>25 <span class="currency">&euro;</span></td>
          <td>13%</td>
          <td>28,75 <span class="currency">&euro;</span></td>
        </tr> -->
      </tbody>
    </table>
  </div>

  <!-- INVOICE TOTAL -->
  <div class="row">
    <div class="offset-2 col-4">
      <div class="to text-right">
        <h5 class="effect-color pt-4">Invoiced to:</h5>
        <h4 class="theme-color"><strong>{{ sale.customer.first_name }}</strong></h4>
        <h6>{{ sale.customer.address }}</h6>
        <p>{{ sale.customer.phone }}</p>
        <h5>GSTIN : {{ sale.customer.gstin }}</h5>
      </div>
    </div>
    <div class="col-6 pr-5">
      <table class="table table-borderless text-right">
        <tbody>
          <tr>
              <th>Subtotal</th>
              <td>₹{{ sale.sub_total|floatformat:2 }}</td>
          </tr>
          <tr>
              <th>GST (%)</th>
              <td>{{ sale.tax_percentage }}%</td>
          </tr>
          <tr>
              <th>GST Amount</th>
              <td>₹{{ sale.tax_amount|floatformat:2 }}</td>
          </tr>
          <tr>
              <th>Shipping</th>
              <td>₹0.00</td> <!-- You can change this if shipping applies -->
          </tr>
          <tfoot>
            <tr class="fw-bold">
              <th>Total Amount</th>
              <td>₹{{ sale.grand_total|floatformat:2 }}</td>
            </tr>
            <tr class="table-success fw-bold">
                <th>Amount Paid</th>
                <td>₹{{ sale.amount_paid|floatformat:2 }}</td>
            </tr>
            <tr class="{% if sale.amount_change > 0 %}table-warning{% else %}table-success{% endif %} fw-bold">
                <th>Balance Due</th>
                <td>₹{{ total_after_payment|floatformat:2 }}</td>
            </tr>
        </tfoot>
        
        
      </tbody>
      
      </table>
    </div>
  </div>

  <!-- <p class="text-center mt-3"><em>* Taxes calculated in &euro; using default regional values</em></p> -->

  <!-- FOOTER SIGNATURE SECTION -->
  <div class="footer-signature row mt-5" style="padding-top: 40px; padding-bottom: 40px;">
    <div class="col-6 signature-block">
      <div class="signature-line"></div>
      <p>Company Signature</p>
    </div>
    <div class="col-6 signature-block">
      <div class="signature-line"></div>
      <p>Client Signature</p>
    </div>
  </div>
</div>


<!-- Download Button -->
<div class="text-center my-4">
  <button id="downloadBtn" class="btn btn-primary">Download PDF</button>
</div>


<!-- Scripts -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  document.getElementById("downloadBtn").addEventListener("click", function () {
    const { jsPDF } = window.jspdf;
    const invoice = document.getElementById("invoice");

    html2canvas(invoice, {
      scale: 3,
      useCORS: true
    }).then(canvas => {
      const imgData = canvas.toDataURL("image/jpeg"); // or use image/png for better quality
      const pdf = new jsPDF("p", "mm", "a4");

      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

      pdf.addImage(imgData, "JPEG", 0, 0, pdfWidth, pdfHeight);
      // pdf.save("invoice.pdf");  // ✅ Save as PDF, not .jpeg
      const now = new Date();
      const pad = (n) => n.toString().padStart(2, '0');

      const day = pad(now.getDate());
      const month = pad(now.getMonth() + 1); // JS months are 0-indexed
      const year = now.getFullYear();
      const hours = pad(now.getHours());
      const minutes = pad(now.getMinutes());

      const formattedDate = `${day}-${month}-${year}_${hours}-${minutes}`;
      const invoiceNo = "INV{{ sale.id }}";
      const filename = `${invoiceNo}_${formattedDate}.pdf`;

      pdf.save(filename);

    });
  });
</script>
</body>
</html>
{% endblock %}
