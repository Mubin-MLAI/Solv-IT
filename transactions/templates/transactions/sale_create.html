{% extends "store/base.html" %}
{% load static %}
<!-- Page title  -->
{% block title %}Create sale{% endblock title %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<!--Select2 CSS-->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css">
{% endblock stylesheets %}

<!-- Page Heading -->
<h2>Add sale</h2>

<!-- Page content  -->
{% block content %}

<style>
/* ===== GLOBAL DARK THEME ===== */
body {
    background-color: #111 !important;
    color: #f1f1f1 !important;
}

/* Cards */
.card {
    background: #1a1a1a !important;
    border: 1px solid #2b2b2b !important;
}
.card-header {
    background: #0d6e4f !important; /* keep your success color */
    border-bottom: 1px solid #2b2b2b !important;
}

/* Inputs */
.form-control,
.form-select,
.select2-selection {
    background-color: #222 !important;
    color: #fff !important;
    border: 1px solid #444 !important;
}
.form-control:focus,
.form-select:focus,
.select2-selection:focus {
    background-color: #2c2c2c !important;
    border-color: #00c47a !important;
    box-shadow: 0 0 0 0.25rem rgba(1, 156, 252, 0.349) !important;
}

/* Buttons */
.btn {
    border-radius: 6px !important;
}
.btn-success {
    background: linear-gradient(90deg, #00a86b, #00d48f) !important;
    border: none !important;
}
.btn-outline-success {
    color: #00d48f !important;
    border-color: #00d48f !important;
}
.btn-outline-success:hover {
    background-color: #00d48f !important;
    color: #111 !important;
}
.btn-danger {
    background: linear-gradient(90deg, #b30021, #e6002a) !important;
    border: none !important;
}

/* Tables */
/* âœ… Table Styling */
    .table-container {
    width: 100%;
    background: #161b22;
    border-radius: 16px;
    overflow-x: auto;
    border: 1px solid #30363d;
}
table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
}
thead th {
    background-color: #22262e;
    color: #00ffc8;
    text-align: center;
    padding: 8px;
}
tbody td {
    text-align: center;
    border-bottom: 1px solid #30363d;
    padding: 10px 7px;
}
tbody tr:hover {
    background-color: #1c2128;
}

/* Dropdowns / Select2 */
.select2-dropdown {
    background: #222 !important;
    color: #fff !important;
}
.select2-results__option {
    background: #222 !important;
    color: #fff !important;
}
.select2-results__option--highlighted {
    background: #028dff !important;
}

/* Autocomplete suggestions */
#customer_suggestions,
#item_suggestions {
    background: #1c1c1c !important;
    border: 1px solid #333 !important;
    color: #fff !important;
}
.list-group-item {
    background: #1c1c1c !important;
    color: #fff !important;
}
.list-group-item:hover {
    background: #686c6d !important;
    color: #fff !important;
}



/* Modal */
.modal-content {
    background: #1a1a1a !important;
    color: #fff !important;
    border: 1px solid #333 !important;
}
.modal-header,
.modal-footer {
    border-color: #333 !important;
}

/* Alerts */
.alert-success {
    background: #0d6e4f !important;
    border: none !important;
    color: #fff !important;
}

/* DataTables */
.dataTables_wrapper .dataTables_filter input {
    background: #222 !important;
    color: #fff !important;
    border: 1px solid #444 !important;
}
.dataTables_wrapper .dataTables_length select {
    background: #222 !important;
    color: #fff !important;
}
.dataTables_wrapper .dataTables_paginate .paginate_button {
    color: #fff !important;
    background: #222 !important;
    border: 1px solid #444 !important;
}
.dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: #0d6e4f !important;
}

label.form-label {
        color: #bdbdbd;
        font-weight: 500;
        text-transform: uppercase;
        font-size: 0.9rem;
        margin-bottom: 6px;
    }

input.form-control::placeholder,
    textarea.form-control::placeholder {
        color: #999;
    }

/* SweetAlert2 */
.swal2-popup {
    background: #1e1e1e !important;
    color: #fff !important;
}
.swal2-title {
    color: #fff !important;
}
.swal2-styled.swal2-confirm {
    background: #00d48f !important;
}
.swal2-styled.swal2-cancel {
    background: #b30021 !important;
}
</style>


<div class="container py-5">
    <!-- Go back -->
    <!-- <div class="mb-4">
        <a href="{% url 'saleslist' %}" class="btn btn-outline-success">
            <i class="fas fa-arrow-left me-2"></i>
            Go back
        </a>
    </div> -->

    <form id="form_sale" action="{% url 'sale-create' %}" class="saleForm" method="post">
        {% csrf_token %}

        <!-- Sale Items Table (Full Width at Top) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-light shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Sale Items</h5>
                    </div>

                    <div class="card-body">
                        <div class="mb-3">
                            <label for="customer_searchbox" class="form-label">Customer Name</label>
                            <input type="text" id="customer_searchbox" class="form-control" placeholder="Type Customer Name / Phone ... " autocomplete="off">
                            <div id="customer_suggestions" class="form-label" style="z-index: 1000;"></div>
                            <input type="hidden" name="customer_id" id="customer_id">  <!-- Hidden field to submit ID -->
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="excel_upload" class="form-label">Upload Excel with Serial Numbers</label>
                            <input type="file" id="excel_upload" accept=".xlsx, .xls" class="form-control">
                            <button type="button" id="process_excel_btn" class="btn btn-primary mt-2">Upload & Add
                                Items</button>
                        </div>
                        <div style="color: red;"> OR </div>
                        <!-- Search item -->
                        <div class="mb-4 position-relative">
                            <label for="searchbox_items" class="form-label">Search Item:</label>
                            <input type="text" class="form-control select2" name="searchbox_items" id="searchbox_items" aria-label="Search items" placeholder="Enter Product Serial Number" autocomplete="off">
                            <div id="item_suggestions" class="form-label" style="z-index: 1000;"></div>
                        </div>

                        <!-- Delete all items -->
                        <button type="button" class="btn btn-danger btn-sm mb-4 deleteAll">
                            <i class="fas fa-trash-alt me-2"></i> Delete All Items
                        </button>

                        <!-- Items Table -->
                        <div class="table-responsive my-3">
                            <table class="table-container table-bordered table-striped" id="table_items">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Serial No</th>
                                        <th>Description</th>
                                        <th>Price</th>
                                        <th>Sell Price</th>
                                        <th>Discount Amount</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <!-- <p class="text-muted mt-2 ">
                                    <span class="badge bg-warning text-light form-label">Note:</span> Highlighted rows
                                        indicate low stock.
                                </p> -->
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sale Details Section -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card border-light shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Sale Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="total_discount_amount" class="form-label">Total Discount Amount (All Items)</label>
                            <input name="total_discount_amount" type="text" class="form-control" id="total_discount_amount"
                                aria-label="Total Discount Amount (All Items)" readonly>
                        </div>
                        <div class="mb-3">
                            <label for="sub_total" class="form-label">Sub Total Amount</label>
                            <input name="sub_total" type="text" class="form-control" id="sub_total"
                                aria-label="Subtotal" required>
                        </div>
                        <div class="mb-3">
                            <!-- <label for="actual_total_price_before_discount" class="form-label">Sub Total Amount</label> -->
                            <input name="actual_total_price_before_discount" type="text" class="form-control" id="actual_total_price_before_discount"
                                aria-label="actual_total_price_before_discount" hidden readonly>
                        </div>
                        <div class="mb-3">
                            <label for="tax_percentage" class="form-label">GST Inclusive (%)</label>
                            <select name="tax_percentage" id="tax_percentage" class="form-select">
                                <option value="0.0">0%</option>
                                <option value="0.25">0.25%</option>
                                <option value="3.0">3%</option>
                                <option value="5.0">5%</option>
                                <option value="12.0">12%</option>
                                <option value="18.0">18%</option>
                                <option value="28.0">28%</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="tax_amount" class="form-label">Tax Amount</label>
                            <input name="tax_amount" type="text" class="form-control" id="tax_amount"
                                aria-label="Tax Amount">
                        </div>
                        <div class="mb-3">
                            <label for="grand_total" class="form-label">Grand Total Amount</label>
                            <input name="grand_total" type="text" class="form-control" id="grand_total"
                                aria-label="Grand Total" required readonly>
                        </div>
                        <div class="mb-3">
                            <label for="amount_paid" class="form-label">Amount Payed</label>
                            <input name="amount_paid" type="text" class="form-control" id="amount_paid"
                                aria-label="Amount Paid">
                        </div>
                        <div class="mb-3">
                            <label for="payment_type" class="form-label">Payment Type</label>
                            <select name="payment_type" id="payment_type" class="form-control">
                                <option value="Cash">Cash</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Bank">Bank</option>
                            </select>
                        </div>

                        <div id="bank_account_group" class="mb-3" style="display: none;">
                            <label for="bank_account" class="form-label">Bank Account</label>
                            <select name="bank_account" id="bank_account" class="form-control">
                                {% for acc in bank_accounts %}
                                {% if acc.account_name %}
                                <option value="{{ acc.id }}">{{ acc.account_name }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success w-100">Create Sale</button>
                    </div>
                </div>
            </div>

            <!-- Add optional second column for future use or notes -->
            <div class="col-lg-6 mb-4">
                <!-- You can add another card or content here if needed -->
            </div>
        </div>
    </form>
</div>

<!-- Customer Create Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="createCustomerForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" name="first_name" class="form-control" placeholder="Enter First Name"><br>
                    <input type="text" name="last_name" class="form-control" placeholder="Enter Last Name"><br>
                    <input type="number" name="phone" class="form-control" placeholder="Enter Phone Number">
                    <!-- Add other fields as needed -->
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock content %}

<style>
    /* Style for suggestion dropdown */
    #customer-suggestions.show {
        display: block;
    }
    #customer-suggestions {
        cursor: pointer;
        z-index: 1050;
    }
    #customer-suggestions .dropdown-item.active, #customer-suggestions .dropdown-item:hover {
        background-color: #f8f9fa;
        color: #212529;
    }
</style>

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}

<script>
$(function() {
    var $input = $('#customer');
    var $suggestions = $('#customer-suggestions');
    var typingTimer;
    var lastResults = [];

    $input.on('input', function() {
        clearTimeout(typingTimer);
        var query = $(this).val();
        if (query.length < 2) {
            $suggestions.removeClass('show').empty();
            return;
        }
        typingTimer = setTimeout(function() {
            $.ajax({
                url: '/transactions/customers/',
                data: { q: query },
                dataType: 'json',
                success: function(data) {
                    lastResults = data.results || [];
                    if (lastResults.length === 0) {
                        $suggestions.html('<span class="dropdown-item disabled">No matches found</span>').addClass('show');
                        return;
                    }
                    var html = lastResults.map(function(item, idx) {
                        return '<span class="dropdown-item" data-idx="'+idx+'">'+item.text+'</span>';
                    }).join('');
                    $suggestions.html(html).addClass('show');
                },
                error: function() {
                    $suggestions.html('<span class="dropdown-item disabled">Error fetching suggestions</span>').addClass('show');
                }
            });
        }, 250);
    });

    // Click on suggestion
    $suggestions.on('click', '.dropdown-item:not(.disabled)', function() {
        var idx = $(this).data('idx');
        if (lastResults[idx]) {
            var item = lastResults[idx];
            var fullName = (item.first_name && item.last_name) ? (item.first_name + ' ' + item.last_name) : item.text;
            $input.val(fullName);
            $suggestions.removeClass('show').empty();
        }
    });

    // Hide suggestions on blur (with slight delay for click)
    $input.on('blur', function() {
        setTimeout(function() { $suggestions.removeClass('show').empty(); }, 200);
    });

    // Keyboard navigation
    $input.on('keydown', function(e) {
        var $items = $suggestions.find('.dropdown-item:not(.disabled)');
        var $active = $items.filter('.active');
        if (!$suggestions.hasClass('show') || !$items.length) return;
        if (e.key === 'ArrowDown') {
            e.preventDefault();
            var idx = $items.index($active);
            $active.removeClass('active');
            $items.eq((idx+1)%$items.length).addClass('active');
        } else if (e.key === 'ArrowUp') {
            e.preventDefault();
            var idx = $items.index($active);
            $active.removeClass('active');
            $items.eq((idx-1+$items.length)%$items.length).addClass('active');
        } else if (e.key === 'Enter') {
            if ($active.length) {
                $active.click();
                e.preventDefault();
            }
        }
    });
});
</script>
<!-- Datatables -->

<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js" defer></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js" defer></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>

<!-- Bootstrap Touchspin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-touchspin/3.1.0/jquery.bootstrap-touchspin.min.js"
    defer></script>

<!-- Sweet Alert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.15/dist/sweetalert2.all.min.js" defer></script>


<script>
    function customerSearchSuggestions() {
        const searchBox = document.getElementById('customer_searchbox');
        const suggestionsBox = document.getElementById('customer_suggestions');
        const hiddenField = document.getElementById('customer_id');
        const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));

        searchBox.addEventListener('input', function () {
            const query = searchBox.value;
            if (query.length >= 2) {
                fetch(`/search-customer/?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsBox.innerHTML = '';
                        if (data.results && data.results.length > 0) {
                            data.results.forEach(suggestion => {
                                const item = document.createElement('a');
                                item.href = 'javascript:void(0);';
                                item.classList.add('list-group-item', 'list-group-item-action');
                                item.textContent = suggestion.text;

                                item.addEventListener('click', function () {
                                    searchBox.value = suggestion.text;
                                    hiddenField.value = suggestion.id;
                                    suggestionsBox.innerHTML = '';
                                });

                                suggestionsBox.appendChild(item);
                            });
                        } else {
                            const noItem = document.createElement('a');
                            noItem.classList.add('list-group-item', 'list-group-item-action', 'text-danger');
                            noItem.textContent = 'No customer found. Click to add.';
                            noItem.style.cursor = 'pointer';
                            noItem.addEventListener('click', function () {
                                // Show the modal instead of redirecting
                                customerModal.show();
                                // Pre-fill the name if it exists in the search box
                                const searchValue = searchBox.value.trim();
                                if (searchValue) {
                                    const names = searchValue.split(' ');
                                    document.querySelector('#customerModal input[name="first_name"]').value = names[0] || '';
                                    document.querySelector('#customerModal input[name="last_name"]').value = names.slice(1).join(' ') || '';
                                }
                            });
                            suggestionsBox.appendChild(noItem);
                        }
                    })
                    .catch(err => {
                        console.error('Error fetching customer suggestions:', err);
                    });
            } else {
                suggestionsBox.innerHTML = '';
                hiddenField.value = '';
            }
        });

        // Handle customer form submission
        document.getElementById('createCustomerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            // Add CSRF token
            const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            
            fetch("{% url 'create_customer_ajax' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the customer search box and hidden field with new customer data
                    searchBox.value = data.customer.full_name;
                    hiddenField.value = data.customer.id;
                    
                    // Close the modal and clear the form
                    customerModal.hide();
                    document.getElementById('createCustomerForm').reset();
                    
                    // Clear suggestions box
                    suggestionsBox.innerHTML = '';
                    
                    // Show success message
                    const alertDiv = document.createElement('div');
                    alertDiv.className = 'alert alert-success';
                    alertDiv.textContent = 'Customer created successfully!';
                    document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('form'));
                    
                    // Remove alert after 3 seconds
                    setTimeout(() => alertDiv.remove(), 3000);
                } else {
                    // Show error message
                    alert(data.error || 'Error creating customer');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error creating customer');
            });
        });
    }

// Call it
customerSearchSuggestions();

</script>

<script>
    $('#createCustomerForm').on('submit', function(e) {
        e.preventDefault();
        let formData = $(this).serialize();
    
        $.ajax({
            type: 'POST',
            url: '/transactions/customers/create/',
            data: formData,
            headers: { "X-CSRFToken": "{{ csrf_token }}" },
            success: function (data) {
                var newOption = new Option(data.text, data.id, true, true);
                $('#customer').append(newOption).trigger('change');
                $('#customerModal').modal('hide');
            },
            error: function (xhr) {
                alert("Error creating customer: " + xhr.responseJSON.message);
            }
        });
    });
</script>
    

<script>
    // Removed Select2 initialization for #customer since it is now a plain text input
</script>



<script>

    $(document).ready(function () {
        // Form submission
        $('#saleForm').submit(function (e) {
            e.preventDefault();

            if (!$('#customerId').val()) {
                alert('Please select or add a customer');
                return;
            }

            // Here you would submit the full form data
            alert('Sale would be submitted now for customer ID: ' + $('#customerId').val());
            // this.submit(); // Uncomment to actually submit the form
        });
    });

    //show/hide the bank_account field depending on the selected payment_type
    $('#payment_type').on('change', function () {
        if ($(this).val() === 'Bank') {
            $('#bank_account_group').show();
        } else {
            $('#bank_account_group').hide();
            $('#bank_account').val('');
        }
    });
    // Source: https://stackoverflow.com/a/32605063
    function roundTo(n, digits) {
        if (digits === undefined) {
            digits = 0;
        }

        var multiplicator = Math.pow(10, digits);
        n = parseFloat((n * multiplicator).toFixed(11));
        return Math.round(n) / multiplicator;
    }

    // Variable for item number in table
    var number = 1;

    // Variable to store sale details and products
    var sale = {
        products: {
            customer: 0,
            sub_total: 0.00,
            grand_total: 0.00,
            tax_amount: 0.00,
            tax_percentage: 0.00,
            amount_payed: 0.00,
            amount_change: 0.00,
            discount_amount: 0.00,
            items: []
        },
        calculate_sale: function () {
            // Subtotal of all items added
            var sub_total = 0.00;
            var total_discount_amount = 0.00;
            var actual_total_price_before_discount = 0.00;

            var tax_percentage = parseFloat($('#tax_percentage').val()) || 0;
            var discount_amount = parseFloat($('#discount_amount').val()) || 0;

            // Calculates the total for each item using sell price minus discount
            $.each(this.products.items, function (pos, dict) {
                dict.pos = pos;
                var sellPrice = (dict.sell_price !== undefined && !isNaN(dict.sell_price)) ? parseFloat(dict.sell_price) : 0;
                var discountAmount = (dict.discount_amount !== undefined && !isNaN(dict.discount_amount)) ? parseFloat(dict.discount_amount) : 0;
                var quantity = dict.quantity || 0;
                // Calculate and accumulate the actual total price before discount (raw sell price * quantity)
                actual_total_price_before_discount += quantity * sellPrice;
                var totalAfterDiscount = roundTo(quantity * (sellPrice - discountAmount), 2);
                dict.total_item = totalAfterDiscount;
                // Add the item total after discount to the sale subtotal
                sub_total += totalAfterDiscount;
                // Add per-item discount to total_discount_amount
                total_discount_amount += discountAmount * quantity;
            });

            // Update the actual_total_price_before_discount field (hidden input)
            $('#actual_total_price_before_discount').val(roundTo(actual_total_price_before_discount, 2));

            // Update the total discount amount field
            $('#total_discount_amount').val(roundTo(total_discount_amount, 2));

            // Update the sale subtotal
            this.products.sub_total = roundTo(sub_total, 2);
            $('input[name="sub_total"]').val(this.products.sub_total);

            // Apply extra/overall discount to subtotal
            var discounted_subtotal = this.products.sub_total - discount_amount;
            if (discounted_subtotal < 0) discounted_subtotal = 0;
            this.products.discount_amount = discount_amount;
            $('input[name="discount_amount"]').val(this.products.discount_amount);

            this.products.sub_total = roundTo(discounted_subtotal, 2);
            $('input[name="sub_total"]').val(this.products.sub_total);

            // Calculate tax on discounted subtotal
            this.products.tax_amount = roundTo(discounted_subtotal * (tax_percentage / 100), 2);
            $('input[name="tax_amount"]').val(this.products.tax_amount);

            // Grand total = discounted subtotal + tax
            this.products.grand_total = roundTo(discounted_subtotal + this.products.tax_amount, 2);
            $('input[name="grand_total"]').val(this.products.grand_total);

            // Auto-fill Amount Payed = Grand Total
            $('input[name="amount_paid"]').val(this.products.grand_total);

        },
        // Adds an item to the sale object
        add_item: function (item) {
            const exists = this.products.items.some(existing => existing.id === item.id);
            if (exists) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Item already added',
                    text: `${item.name} (Serial: ${item.serial_no}) is already in the sale.`
                });
                return;
            }

            this.products.items.push(item);
            this.list_item();
        },
        // Shows the selected item in the table
        list_item: function () {
            this.calculate_sale();

            const tbody = $('#table_items tbody');
            tbody.empty();


            this.products.items.forEach((item, index) => {
                const sellPrice = (item.sell_price !== undefined && !isNaN(item.sell_price)) ? parseFloat(item.sell_price) : 0;
                const discountAmount = (item.discount_amount !== undefined && !isNaN(item.discount_amount)) ? parseFloat(item.discount_amount) : 0;
                const quantity = item.quantity || 0;
                const totalAfterDiscount = ((sellPrice - discountAmount) * quantity).toFixed(2);

                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.serial_no}</td>
                        <td>
                            <ul class="mb-0 ps-3">
                                ${item.description.split(',').map(line => `<li>${line.trim()}</li>`).join('')}
                            </ul>
                        </td>
                        <td>${item.price}</td>
                        <td>
                            <input type="text" 
                                    class="form-control input-sell-price" 
                                    style="width: 120px;" 
                                    data-index="${index}" 
                                    value="${item.sell_price !== undefined ? item.sell_price : ''}">
                        </td>
                        <td>
                            <input type="text" 
                                    class="form-control input-discount-amount" 
                                    style="width: 120px;" 
                                    data-index="${index}" 
                                    value="${item.discount_amount !== undefined ? item.discount_amount : ''}">
                        </td>
                        <td>${item.quantity}</td>
                        <td class="text-end total-sell-price" data-index="${index}">${totalAfterDiscount} RS</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-danger btn-delete" data-index="${index}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

        // Handle sell price or discount amount input change
        $('#table_items tbody').off('input', '.input-sell-price');
        $('#table_items tbody').off('input', '.input-discount-amount');
        $('#table_items tbody').on('input', '.input-sell-price, .input-discount-amount', function () {
            const index = $(this).data('index');
            const sellPrice = parseFloat($(`.input-sell-price[data-index="${index}"]`).val()) || 0;
            const discountAmount = parseFloat($(`.input-discount-amount[data-index="${index}"]`).val()) || 0;
            sale.products.items[index].sell_price = sellPrice;
            sale.products.items[index].discount_amount = discountAmount;
            // Update the total cell for this row
            const quantity = sale.products.items[index].quantity || 0;
            const totalAfterDiscount = ((sellPrice - discountAmount) * quantity).toFixed(2);
            $(`.total-sell-price[data-index="${index}"]`).text(`${totalAfterDiscount} RS`);
            // Recalculate overall totals
            sale.calculate_sale();
        });
        }
    };


    $(document).ready(function () {
        // Tax percentage touchspin
        $('#tax_percentage').on('change', function () {
            sale.calculate_sale();
        });
        $('#discount_amount').on('change', function () {
            sale.calculate_sale();
        });


        // Select2 customers
        $('#searchbox_customers').select2({
            delay: 250,
            placeholder: "Select a customer",
            allowClear: true,
            minimumInputLength: 1,
            ajax: {
                url: "{% url 'get_customers' %}",
                type: 'POST',
                data: function (params) {
                    return {
                        term: params.term,
                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() // Include CSRF token
                    };
                },
                processResults: function (data) {
                    return {
                        results: data
                    };
                }
            }
        }).on('select2:select', function (e) {
            // When a customer is selected
            var data = e.params.data;
            sale.products.customer = data.id;
        });

        // Autocomplete for item serial number
        var itemTypingTimer;
        var $itemInput = $('#searchbox_items');
        var $itemSuggestions = $('#item_suggestions');
        var lastItemResults = [];

        $itemInput.on('input', function() {
            clearTimeout(itemTypingTimer);
            var query = $(this).val().trim();
            if (query.length < 2) {
                $itemSuggestions.empty().hide();
                return;
            }
            itemTypingTimer = setTimeout(function() {
                var csrfToken = $('input[name="csrfmiddlewaretoken"]').val();
                $.ajax({
                    url: "{% url 'get_items' %}",
                    type: 'POST',
                    dataType: 'json',
                    data: {
                        term: query,
                        csrfmiddlewaretoken: csrfToken
                    },
                    success: function(data) {
                        lastItemResults = data || [];
                        if (lastItemResults.length === 0) {
                            $itemSuggestions.html('<div class="list-group-item disabled">No items found</div>').show();
                            return;
                        }
                        var html = lastItemResults.map(function(item, idx) {
                            return '<a href="#" class="list-group-item list-group-item-action" data-idx="'+idx+'">' +
                                item.name + ' (' + item.serial_no + ') - ' + item.description + '</a>';
                        }).join('');
                        $itemSuggestions.html(html).show();
                    },
                    error: function() {
                        $itemSuggestions.html('<div class="list-group-item disabled">Error fetching items</div>').show();
                    }
                });
            }, 250);
        });

        // Click on suggestion
        $itemSuggestions.on('click', '.list-group-item-action:not(.disabled)', function(e) {
            e.preventDefault();
            var idx = $(this).data('idx');
            if (lastItemResults[idx]) {
                var item = lastItemResults[idx];
                item.price = parseFloat(item.price);
                item.quantity = 1;
                sale.add_item(item);
                $itemInput.val("");
                $itemSuggestions.empty().hide();
            }
        });

        // Hide suggestions on blur (with slight delay for click)
        $itemInput.on('blur', function() {
            setTimeout(function() { $itemSuggestions.empty().hide(); }, 200);
        });

        // Keyboard navigation for suggestions
        $itemInput.on('keydown', function(e) {
            var $items = $itemSuggestions.find('.list-group-item-action:not(.disabled)');
            var $active = $items.filter('.active');
            if (!$itemSuggestions.is(':visible') || !$items.length) return;
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                var idx = $items.index($active);
                $active.removeClass('active');
                $items.eq((idx+1)%$items.length).addClass('active');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                var idx = $items.index($active);
                $active.removeClass('active');
                $items.eq((idx-1+$items.length)%$items.length).addClass('active');
            } else if (e.key === 'Enter') {
                if ($active.length) {
                    $active.click();
                    e.preventDefault();
                }
            }
        });


        // Tables Events
        // Handle price or quantity change
        // Handle price or quantity change without redrawing the table
        $('#table_items tbody').on('input', '.input-price, .input-quantity', function () {
            const index = $(this).data('index');
            const price = parseFloat($(`.input-price[data-index="${index}"]`).val()) || 0;
            const quantity = parseInt($(`.input-quantity[data-index="${index}"]`).val()) || 1;

            // Update the item data
            sale.products.items[index].price = price;
            sale.products.items[index].quantity = quantity;
            sale.products.items[index].total_item = price * quantity;

            // Update the total cell directly without full redraw
            const $row = $(this).closest('tr');
            const total = (price * quantity).toFixed(2);
            $row.find('td').eq(6).text(`${total} $`);

            // Recalculate totals for the whole sale
            sale.calculate_sale();  // This only updates the summary fields
        });


        // Handle delete
        $('#table_items tbody').on('click', '.btn-delete', function () {
            const index = $(this).data('index');
            sale.products.items.splice(index, 1);
            sale.list_item();
        });


        // Items datatable
        tblItems = $('#table_items').DataTable({
            columnDefs: [
                {
                    targets: [-1],
                    orderable: false,
                }
            ],
        });

        // Item searchbox templateResult
        function template_item_searchbox(repo) {
            if (repo.loading) return repo.text;

            return $(`
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <h6 class="card-title mb-1">${repo.name} (${repo.serial_no})</h6>
                        <p class="card-text"><small>${repo.description}</small></p>
                    </div>
                </div>
            `);
        }



        // Helper functions
        function getAjax(type, url, data, successCallback, errorCallback) {
            $.ajax({
                type: type,
                url: url,
                data: data,
                success: successCallback,
                error: errorCallback
            });
        }

        // Function to round numbers
        function roundTo(value, decimals) {
            const factor = Math.pow(10, decimals);
            return Math.round(value * factor) / factor;
        }

        // On form submit
        $('form#form_sale').on('submit', function (event) {
            event.preventDefault();

            // Gather sale details
            var amountPaid = parseFloat($('input[name="amount_paid"]').val());
            var grandTotal = parseFloat($('input[name="grand_total"]').val());
            var amountChange = roundTo(grandTotal - amountPaid, 2);

            // Gather sale details
            var formData = {
                customer: $('#customer_id').val(),
                sub_total: $('input[name="sub_total"]').val(),
                grand_total: grandTotal,
                tax_amount: $('input[name="tax_amount"]').val(),
                tax_percentage: $('select[name="tax_percentage"]').val(),
                amount_paid: amountPaid,
                amount_change: amountChange,
                payment_type: $('select[name="payment_type"]').val(),
                bank_account: $('select[name="bank_account"]').val(),  // might be null if not Bank
                total_discount_amount: $('input[name="total_discount_amount"]').val(),
                actual_total_price_before_discount: $('input[name="actual_total_price_before_discount"]').val(),
                items: sale.products.items
            };


            // Check if amount_change is present
            if (isNaN(amountChange)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Amount change is required!'
                });
                return;
            }

            // Get CSRF token
            var csrftoken = $('input[name="csrfmiddlewaretoken"]').val();

            // Submit the form data via AJAX
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                data: JSON.stringify(formData),
                success: function (response) {
                    // Handle success response
                    if (response.redirect) {
                        window.location.href = response.redirect;
                        return;
                    }
                    sale.products.items = [];
                    sale.list_item();
                    $('form#form_sale').trigger('reset');
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Sale has been completed successfully!'
                    });
                },
                error: function (xhr) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: xhr.responseJSON.message || 'An error occurred while processing the sale!'
                    });
                }
            });
        });
    });
</script>

<script>
    $('#process_excel_btn').on('click', function () {
        const fileInput = document.getElementById('excel_upload');
        const file = fileInput.files[0];

        if (!file) {
            Swal.fire('Please select an Excel file');
            return;
        }

        const reader = new FileReader();

        reader.onload = function (e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });

            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

            const serials = jsonData.flat().filter(s => typeof s === 'string' && s.trim() !== '');

            if (serials.length === 0) {
                Swal.fire('No serial numbers found in Excel');
                return;
            }

            const csrfToken = $('input[name="csrfmiddlewaretoken"]').val();

            serials.forEach(serial => {
                $.ajax({
                    url: "{% url 'get_items' %}",
                    type: "POST",
                    headers: { 'X-Requested-With': 'XMLHttpRequest' },
                    data: {
                        term: serial,
                        csrfmiddlewaretoken: csrfToken
                    },
                    success: function (data) {
                        if (data.length > 0) {
                            let item = data[0]; // Take the first match
                            item.price = parseFloat(item.price);
                            item.quantity = 1;
                            sale.add_item(item);
                        } else {
                            console.warn(`No item found for serial: ${serial}`);
                        }
                    },
                    error: function (err) {
                        console.error(`Error fetching item for serial ${serial}:`, err);
                    }
                });
            });
        };

        reader.readAsArrayBuffer(file);
    });


</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Include Select2 CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>



{% endblock javascripts %}