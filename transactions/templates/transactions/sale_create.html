{% extends "store/base.html" %}
{% load static %}
<!-- Page title  -->
{% block title %}Create sale{% endblock title %}

<!-- Specific Page CSS goes HERE  -->
{% block stylesheets %}
<!--Select2 CSS-->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css">
{% endblock stylesheets %}

<!-- Page Heading -->
<h2>Add sale</h2>

<!-- Page content  -->
{% block content %}
<div class="container py-5">
    <!-- Go back -->
    <div class="mb-4">
        <a href="{% url 'saleslist' %}" class="btn btn-outline-success">
            <i class="fas fa-arrow-left me-2"></i>
            Go back
        </a>
    </div>

    <form id="form_sale" action="{% url 'sale-create' %}" class="saleForm" method="post">
        {% csrf_token %}
    
        <!-- Sale Items Table (Full Width at Top) -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-light shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Sale Items</h5>
                    </div>
                    <div class="card-body">
                        <!-- Search item -->
                        <div class="mb-4">
                            <label for="searchbox_items" class="form-label" >Search Item:</label>
                            <select class="form-select select2" name="searchbox_items" id="searchbox_items" aria-label="Search items" ></select>
                        </div>
    
                        <!-- Delete all items -->
                        <button type="button" class="btn btn-danger btn-sm mb-4 deleteAll">
                            <i class="fas fa-trash-alt me-2"></i> Delete All Items
                        </button>
    
                        <!-- Items Table -->
                        <div class="table-responsive my-3">
                            <table class="table table-bordered table-striped" id="table_items">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Name</th>
                                        <th>Serial No</th>
                                        <th>Description</th>
                                        <th>Price</th>
                                        <th>Quantity</th>
                                        <th>Total</th>
                                        <th class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                                <p class="text-muted mt-2">
                                    <small><span class="badge bg-warning text-dark">Note:</span> Highlighted rows indicate low stock.</small>
                                </p>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Sale Details Section -->
        <div class="row">
            <div class="col-lg-6 mb-4">
                <div class="card border-light shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Sale Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="customer" class="form-label">Customer</label>
                            <select name="customer" class="form-select" id="customer" aria-label="Customer" required>
                                <option value="" selected disabled hidden>Select the customer</option>
                                {% for customer in customers %}
                                <option value="{{ customer.value }}">{{ customer.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="sub_total" class="form-label">Subtotal</label>
                            <input name="sub_total" type="number" class="form-control" id="sub_total" aria-label="Subtotal" required>
                        </div>
                        <div class="mb-3">
                            <label for="tax_percentage" class="form-label">GST Inclusive (%)</label>
                            <select name="tax_percentage" id="tax_percentage" class="form-select">
                                <option value="0.0">0%</option>
                                <option value="0.25">0.25%</option>
                                <option value="3.0">3%</option>
                                <option value="5.0">5%</option>
                                <option value="12.0">12%</option>
                                <option value="18.0">18%</option>
                                <option value="28.0">28%</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="tax_amount" class="form-label">Tax Amount</label>
                            <input name="tax_amount" type="number" class="form-control" id="tax_amount" aria-label="Tax Amount" >
                        </div>
                        <div class="mb-3">
                            <label for="grand_total" class="form-label">Grand Total</label>
                            <input name="grand_total" type="number" class="form-control" id="grand_total" aria-label="Grand Total" required readonly>
                        </div>
                        <div class="mb-3">
                            <label for="amount_paid" class="form-label">Amount Payed</label>
                            <input name="amount_paid" type="number" class="form-control" id="amount_paid" aria-label="Amount Paid">
                        </div>
                        <div class="mb-3">
                            <label for="payment_type" class="form-label">Payment Type</label>
                            <select name="payment_type" id="payment_type" class="form-control">
                                <option value="Cash">Cash</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Bank">Bank</option>
                            </select>
                        </div>
                        
                        <div id="bank_account_group" class="mb-3" style="display: none;">
                            <label for="bank_account" class="form-label">Bank Account</label>
                            <select name="bank_account" id="bank_account" class="form-control">
                                {% for acc in bank_accounts %}
                                    {% if acc.account_name %}
                                        <option value="{{ acc.id }}">{{ acc.account_name }}</option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>                                                               
                        <button type="submit" class="btn btn-success w-100">Create Sale</button>
                    </div>
                </div>
            </div>
    
            <!-- Add optional second column for future use or notes -->
            <div class="col-lg-6 mb-4">
                <!-- You can add another card or content here if needed -->
            </div>
        </div>
    </form>
    
</div>
{% endblock content %}

<!-- Specific Page JS goes HERE  -->
{% block javascripts %}
<!-- Datatables -->
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js" defer></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js" defer></script>

<!-- Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js" defer></script>

<!-- Bootstrap Touchspin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-touchspin/3.1.0/jquery.bootstrap-touchspin.min.js" defer></script>

<!-- Sweet Alert -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.6.15/dist/sweetalert2.all.min.js" defer></script>

<script>
    //show/hide the bank_account field depending on the selected payment_type
    $('#payment_type').on('change', function () {
    if ($(this).val() === 'Bank') {
        $('#bank_account_group').show();
    } else {
        $('#bank_account_group').hide();
        $('#bank_account').val('');
    }
});


    // Source: https://stackoverflow.com/a/32605063
    function roundTo(n, digits) {
        if (digits === undefined) {
            digits = 0;
        }

        var multiplicator = Math.pow(10, digits);
        n = parseFloat((n * multiplicator).toFixed(11));
        return Math.round(n) / multiplicator;
    }

    // Variable for item number in table
    var number = 1;

    // Variable to store sale details and products
    var sale = {
        products: {
            customer: 0,
            sub_total: 0.00,
            grand_total: 0.00,
            tax_amount: 0.00,
            tax_percentage: 0.00,
            amount_payed: 0.00,
            amount_change: 0.00,
            items: []
        },
        calculate_sale: function () {
            // Subtotal of all items added
            var sub_total = 0.00;

            var tax_percentage = parseFloat($('#tax_percentage').val()) || 0;


            // Calculates the total for each item
            $.each(this.products.items, function (pos, dict) {
                dict.pos = pos;
                dict.total_item = roundTo(dict.quantity * dict.price, 2);
                // Add the item total to the sale subtotal
                sub_total += roundTo(dict.total_item, 2);
            });

            // Update the sale subtotal, grand total, and tax amount
            this.products.sub_total = roundTo(sub_total, 2);
            this.products.grand_total = roundTo(this.products.sub_total, 2);
            this.products.tax_amount = roundTo(this.products.sub_total * (tax_percentage / 100), 2);

            $('input[name="sub_total"]').val(this.products.sub_total);
            $('input[name="tax_amount"]').val(this.products.tax_amount);

            // Grand total = subtotal + tax
            this.products.grand_total = roundTo(this.products.sub_total + this.products.tax_amount, 2);
            $('input[name="grand_total"]').val(this.products.grand_total);

            // Auto-fill Amount Payed = Grand Total
            $('input[name="amount_paid"]').val(this.products.grand_total);

        },
        // Adds an item to the sale object
        add_item: function (item) {
            const exists = this.products.items.some(existing => existing.id === item.id);
            if (exists) {
                Swal.fire({
                    icon: 'warning',
                    title: 'Item already added',
                    text: `${item.name} (Serial: ${item.serial_no}) is already in the sale.`
                });
                return;
            }

            this.products.items.push(item);
            this.list_item();
        },
        // Shows the selected item in the table
        list_item: function () {
            this.calculate_sale();

            const tbody = $('#table_items tbody');
            tbody.empty();

            this.products.items.forEach((item, index) => {
                const total = (item.price * item.quantity).toFixed(2);
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.serial_no}</td>
                        <td>
                            <ul class="mb-0 ps-3">
                                ${item.description.split(',').map(line => `<li>${line.trim()}</li>`).join('')}
                            </ul>
                        </td>
                        <td><input type="text"  class="form-control  form-control-sm text-center input-price" data-index="${index}" min="0" step="0.01" style="width: 100px;"></td>
                        <td><input type="text" class="form-control form-control-sm text-center input-quantity" value="${item.quantity}" data-index="${index}" min="1" ></td>
                        <td class="text-end">${total} RS</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-danger btn-delete" data-index="${index}">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }
    };

    $(document).ready(function () {
        // Tax percentage touchspin
        $('#tax_percentage').on('change', function () {
            sale.calculate_sale();
        });


        // Select2 customers
        $('#searchbox_customers').select2({
            delay: 250,
            placeholder: "Select a customer",
            allowClear: true,
            minimumInputLength: 1,
            ajax: {
                url: "{% url 'get_customers' %}",
                type: 'POST',
                data: function (params) {
                    return {
                        term: params.term,
                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() // Include CSRF token
                    };
                },
                processResults: function (data) {
                    return {
                        results: data
                    };
                }
            }
        }).on('select2:select', function (e) {
            // When a customer is selected
            var data = e.params.data;
            sale.products.customer = data.id;
        });

        // Select2 items searchbox
        // Select2 for item search
        $('#searchbox_items').select2({
            theme: "bootstrap4",
            placeholder:"Enter Product Serial Number",
            allowClear: true,
            minimumInputLength: 1,
            ajax: {
                url: "{% url 'get_items' %}",  // Make sure this URL is correct
                type: 'POST',
                dataType: 'json',
                delay: 250,
                data: function (params) {
                    return {
                        term: params.term,
                        csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val()
                    };
                },
                processResults: function (data) {
                    if (data.error) {
                        return { results: [] };
                    }

                    return {
                        results: $.map(data, function (item) {
                            return {
                                id: item.id,
                                name: item.name,
                                serial_no: item.serial_no,
                                description: item.description,
                                quantity: item.quantity,
                                price: item.total_item
                            };
                        })
                    };
                }
            },
            templateResult: template_item_searchbox,
            templateSelection: function (repo) {
                return repo.name || repo.text;
            },
            escapeMarkup: function (markup) {
                return markup;
            }
        }).on('select2:select', function (e) {
            var data = e.params.data;
            data.price = parseFloat(data.price);
            data.quantity = 1;
            sale.add_item(data);
            $(this).val(null).trigger('change'); // clear the search box
        });


        // Tables Events
        // Handle price or quantity change
        // Handle price or quantity change without redrawing the table
        $('#table_items tbody').on('input', '.input-price, .input-quantity', function () {
            const index = $(this).data('index');
            const price = parseFloat($(`.input-price[data-index="${index}"]`).val()) || 0;
            const quantity = parseInt($(`.input-quantity[data-index="${index}"]`).val()) || 1;

            // Update the item data
            sale.products.items[index].price = price;
            sale.products.items[index].quantity = quantity;
            sale.products.items[index].total_item = price * quantity;

            // Update the total cell directly without full redraw
            const $row = $(this).closest('tr');
            const total = (price * quantity).toFixed(2);
            $row.find('td').eq(6).text(`${total} $`);

            // Recalculate totals for the whole sale
            sale.calculate_sale();  // This only updates the summary fields
        });


        // Handle delete
        $('#table_items tbody').on('click', '.btn-delete', function () {
            const index = $(this).data('index');
            sale.products.items.splice(index, 1);
            sale.list_item();
        });


        // Items datatable
        tblItems = $('#table_items').DataTable({
            columnDefs: [
                {
                    targets: [-1],
                    orderable: false,
                }
            ],
        });

        // Item searchbox templateResult
        function template_item_searchbox(repo) {
            if (repo.loading) return repo.text;

            return $(`
                <div class="card mb-2">
                    <div class="card-body py-2">
                        <h6 class="card-title mb-1">${repo.name} (${repo.serial_no})</h6>
                        <p class="card-text"><small>${repo.description}</small></p>
                    </div>
                </div>
            `);
        }



        // Helper functions
        function getAjax(type, url, data, successCallback, errorCallback) {
            $.ajax({
                type: type,
                url: url,
                data: data,
                success: successCallback,
                error: errorCallback
            });
        }

        // Function to round numbers
        function roundTo(value, decimals) {
            const factor = Math.pow(10, decimals);
            return Math.round(value * factor) / factor;
        }

        // On form submit
        $('form#form_sale').on('submit', function (event) {
            event.preventDefault();

            // Gather sale details
            var amountPaid = parseFloat($('input[name="amount_paid"]').val());
            var grandTotal = parseFloat($('input[name="grand_total"]').val());
            var amountChange = roundTo(grandTotal - amountPaid, 2);

            // Gather sale details
            var formData = {
                customer: $('select[name="customer"]').val(),
                sub_total: $('input[name="sub_total"]').val(),
                grand_total: grandTotal,
                tax_amount: $('input[name="tax_amount"]').val(),
                tax_percentage: $('select[name="tax_percentage"]').val(),
                amount_paid: amountPaid,
                amount_change: amountChange,
                payment_type: $('select[name="payment_type"]').val(),
                bank_account: $('select[name="bank_account"]').val(),  // might be null if not Bank
                items: sale.products.items
            };


            // Check if amount_change is present
            if (isNaN(amountChange)) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Amount change is required!'
                });
                return;
            }

            // Get CSRF token
            var csrftoken = $('input[name="csrfmiddlewaretoken"]').val();

            // Submit the form data via AJAX
            $.ajax({
                url: $(this).attr('action'),
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'X-CSRFToken': csrftoken
                },
                data: JSON.stringify(formData),
                success: function (response) {
                    // Handle success response
                    sale.products.items = [];
                    sale.list_item();
                    $('form#form_sale').trigger('reset');
                    Swal.fire({
                        icon: 'success',
                        title: 'Success',
                        text: 'Sale has been completed successfully!'
                    });
                },
                error: function (xhr) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: xhr.responseJSON.message || 'An error occurred while processing the sale!'
                    });
                }
            });
        });
    });
</script>

{% endblock javascripts %}