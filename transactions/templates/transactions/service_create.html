{% extends "store/base.html" %}
{% load static %}

{% block title %}Service Billing{% endblock title %}


<!-- External Libraries -->
{% block stylesheets %}
<style>
/* ---------------------------------------------------------
   BLUE NEON UI/UX — Modern Dark Cyber Theme
--------------------------------------------------------- */

body {
    background: #05060a !important;
    color: #e8ecff !important;
    font-family: 'Inter', sans-serif;
}

/* Page container */
.container {
    background: #0a0c12;
    padding: 25px;
    border-radius: 18px;
    box-shadow: 0 0 25px rgba(0, 183, 255, 0.15);
}

/* Headings & Labels */
h3, label {
    color: #8ecbff !important;
    font-weight: 600;
    letter-spacing: 0.5px;
}

/* Inputs */
.form-control,
select,
textarea {
    background: #0f1117 !important;
    color: #e8ecff !important;
    border: 1px solid #1f2a33 !important;
    border-radius: 10px !important;
    transition: 0.2s;
}

.form-control::placeholder {
    color: #7fa7cc !important;
}

.form-control:focus {
    border-color: #00a6ff !important;
    box-shadow: 0 0 10px #009dff !important;
    background: #0f121b !important;
    color: #ffffff !important;
}

/* Buttons */
.btn-primary {
    background: #009dff !important;
    border: none !important;
    border-radius: 10px !important;
    box-shadow: 0 0 10px #009dff;
}

.btn-success {
    background: #00d2ff !important;
    border-radius: 10px !important;
    color: black !important;
    box-shadow: 0 0 10px #00d2ff;
}

.btn-danger {
    background: #ff355b !important;
    border-radius: 10px !important;
    box-shadow: 0 0 10px rgba(255, 53, 91, 0.5);
}

/* Table */
/* ✅ Table Styling */
    .table-container {
    width: 100%;
    background: #161b22;
    border-radius: 16px;
    overflow-x: auto;
    border: 1px solid #30363d;
}
table {
    width: 100%;
    border-collapse: collapse;
    min-width: 900px;
}
thead th {
    background-color: #22262e;
    color: #00ffc8;
    text-align: center;
    padding: 8px;
}
tbody td {
    text-align: center;
    border-bottom: 1px solid #30363d;
    padding: 10px 7px;
}
tbody tr:hover {
    background-color: #1c2128;
}

/* Table fields size */
#table_items input.form-control,
#table_items textarea.form-control {
    min-width: 140px;
    width: 100%;
}

/* Blue neon hover highlight */
.table tbody tr:hover {
    background: #0e141d !important;
    box-shadow: inset 0 0 10px rgba(0, 157, 255, 0.25);
}

/* Suggestion Dropdown */
#customer_suggestions {
    background: #0d1016 !important;
    border: 1px solid #1e2b35 !important;
    border-radius: 8px;
    max-height: 200px;
    overflow-y: auto;
    position: absolute;
    width: 100%;
    z-index: 2000;
}

#customer_suggestions .list-group-item {
    background: #0d1016;
    color: #9fcaff;
    border: none;
}

#customer_suggestions .list-group-item:hover {
    background: #009dff !important;
    color: white !important;
    box-shadow: inset 0 0 10px rgba(0, 157, 255, 0.6);
}

/* Modal */
.modal-content {
    background: #0c0f15 !important;
    color: #d8eaff !important;
    border-radius: 14px;
    border: 1px solid #153047;
}

.modal-header,
.modal-footer {
    border-color: #192a3d !important;
}

.modal-content input {
    background: #11151d !important;
    border: 1px solid #1d2d40 !important;
}

.modal-content input:focus {
    border-color: #00a6ff !important;
    box-shadow: 0 0 10px #00a6ff !important;
}

/* Payment section boxes */
.form-group {
    background: #0c0f14;
    padding: 12px;
    border-radius: 10px;
    border: 1px solid #1a2633;
    margin-bottom: 12px;
}

/* Responsive */
@media (max-width: 768px) {
    #table_items th, #table_items td {
        font-size: 13px;
        padding: 4px;
    }
    #table_items input.form-control,
    #table_items textarea.form-control {
        min-width: 80px;
    }
}

/* Table wrapper */
.table-responsive {
    overflow-x: auto;
    width: 100%;
}

</style>
{% endblock stylesheets %}

{% block content %}

<div class="container mt-4">
    <h3 class="mb-4">Service Billing</h3>

    <form id="saleForm" action="{% url 'servicebill_create' %}" method="post">
        {% csrf_token %}

        <!-- Customer Input -->
        <div class="form-group mb-3 position-relative">
            <label>Customer Name</label>
            <input type="text" id="customer_searchbox" class="form-control" placeholder="Search by name / phone..." autocomplete="off">
            <div id="customer_suggestions" class="form-label" style="z-index: 1000;"></div>
            <input type="hidden" name="customer_id" id="customer_id">
        </div>


        

        <!-- Items Table -->
        <div class="table-responsive">
            <table id="table_items" class="table-container table-bordered rounded">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Item</th>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>Amount</th>
                        <th>Tax %</th>
                        <th>Tax Amt</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <br>
        <button type="button" class="btn btn-primary mb-3" id="addRowBtn">Add Row</button>

        <!-- Totals -->
        <div class="row">
            <div class="col-md-4 offset-md-8">
                <div class="form-group">
                    <label>Total Amount</label>
                    <input type="text" id="total_amount" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Total Tax</label>
                    <input type="text" id="total_tax" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Grand Total</label>
                    <input type="text" id="grand_total" class="form-control" readonly>
                </div>
            </div>
        </div>

        <!-- Payment -->
        <div class="form-group mt-3">
            <label>Amount Paid</label>
            <input name="amount_paid" id="amount_paid" type="number" class="form-control" min="0" step="0.01">
        </div>

        <div class="form-group mt-3">
            <label>Payment Type</label>
            <select id="payment_type" name="payment_type" class="form-control">
                <option value="Cash">Cash</option>
                <option value="Cheque">Cheque</option>
                <option value="Bank">Bank</option>
            </select>
        </div>

        <div id="bank_account_group" class="form-group mt-3" style="display: none;">
            <label>Bank Account</label>
            <select id="bank_account" name="bank_account" class="form-control">
                {% for acc in bank_accounts %}
                    {% if acc.account_name %}
                        <option value="{{ acc.id }}">{{ acc.account_name }}</option>
                    {% endif %}
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn btn-success mt-4">Submit Sale</button>
    </form>
</div>

<!-- Customer Create Modal -->
<div class="modal fade" id="customerModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="createCustomerForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Create New Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" name="first_name" class="form-control" placeholder="First Name"><br>
                    <input type="text" name="last_name" class="form-control" placeholder="Last Name"><br>
                    <input type="number" name="phone" class="form-control" placeholder="Phone Number">
                </div>
                <div class="modal-footer">
                    <button class="btn btn-primary">Create</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock content %}

{% block javascripts %}
<!-- JS Libraries -->
<!-- EXTRA BOOTSTRAP FIX -->
<script>
document.querySelectorAll('.dropdown-toggle').forEach(el => new bootstrap.Dropdown(el));
</script>



<script>
$(document).ready(function () {
    let rowIndex = 0;

    // ------------------ Customer Search + Create ------------------ //
    function customerSearchSuggestions() {
        const searchBox = $("#customer_searchbox");
        const suggestionsBox = $("#customer_suggestions");
        const hiddenField = $("#customer_id");
        const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));

        searchBox.on("input", function () {
            const query = $(this).val();
            if (query.length >= 2) {
                fetch(`/search-customer/?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsBox.empty();
                        if (data.results && data.results.length > 0) {
                            data.results.forEach(suggestion => {
                                const item = $(`<a href="javascript:void(0);" class="list-group-item list-group-item-action">${suggestion.text}</a>`);
                                item.on("click", function () {
                                    searchBox.val(suggestion.text);
                                    hiddenField.val(suggestion.id);
                                    suggestionsBox.empty();
                                });
                                suggestionsBox.append(item);
                            });
                        } else {
                            const noItem = $(`<a class="list-group-item list-group-item-action text-danger" style="cursor:pointer;">No customer found. Click to add.</a>`);
                            noItem.on("click", function () {
                                customerModal.show();
                                const names = query.split(" ");
                                $("#customerModal input[name='first_name']").val(names[0] || "");
                                $("#customerModal input[name='last_name']").val(names.slice(1).join(" ") || "");
                            });
                            suggestionsBox.append(noItem);
                        }
                    })
                    .catch(err => console.error("Error fetching customer suggestions:", err));
            } else {
                suggestionsBox.empty();
                hiddenField.val("");
            }
        });

        // Handle new customer create (AJAX)
        $("#createCustomerForm").on("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const csrfToken = $("[name=csrfmiddlewaretoken]").val();

            fetch("{% url 'create_customer_ajax' %}", {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    searchBox.val(data.customer.full_name);
                    hiddenField.val(data.customer.id);
                    customerModal.hide();
                    this.reset();
                    suggestionsBox.empty();
                    alert("Customer created successfully!");
                } else {
                    alert(data.error || "Error creating customer");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error creating customer");
            });
        });
    }
    customerSearchSuggestions();

    // ------------------ Add Row ------------------ //
    $("#addRowBtn").click(function () {
        rowIndex++;
        $("#table_items tbody").append(`
            <tr>
                <td class="row-number"></td>
                <td><input type="text" name="items[][item_name]" class="form-control item"></td>
                <td><textarea name="items[][description]" class="form-control description"></textarea></td>
                <td><input type="number" name="items[][qty]" class="form-control qty" value="1" min="1"></td>
                <td><input type="number" name="items[][amount]" class="form-control amount" value="0" min="0" step="0.01"></td>
                <td><input type="number" name="items[][tax_percent]" class="form-control tax" value="0" min="0" step="0.01"></td>
                <td><input type="number" name="items[][tax_amt]" class="form-control tax-amt" value="0" min="0" step="0.01"></td>
                <td><button type="button" class="btn btn-danger btn-sm remove-row"><i class="fa fa-trash"></i></button></td>
            </tr>
        `);
        renumberRows();
    });

    // ------------------ Renumber Rows ------------------ //
    function renumberRows() {
        $("#table_items tbody tr").each(function (index) {
            $(this).find(".row-number").text(index + 1);
        });
    }

    // ------------------ Update Totals ------------------ //
    function updateSummary() {
        let totalAmount = 0, totalTax = 0, grandTotal = 0;
        $("#table_items tbody tr").each(function () {
            const qty = parseFloat($(this).find(".qty").val()) || 0;
            const amount = parseFloat($(this).find(".amount").val()) || 0;
            const taxPerc = parseFloat($(this).find(".tax").val()) || 0;
            const taxAmt = (amount * taxPerc) / 100;
            $(this).find(".tax-amt").val(taxAmt.toFixed(2));
            totalAmount += amount;
            totalTax += taxAmt;
        });
        grandTotal = totalAmount + totalTax;
        $("#total_amount").val(totalAmount.toFixed(2));
        $("#total_tax").val(totalTax.toFixed(2));
        $("#grand_total").val(grandTotal.toFixed(2));
        $("#amount_paid").val(grandTotal.toFixed(2));
    }
    $(document).on("input", ".qty, .amount, .tax", updateSummary);

    // ------------------ Remove Row ------------------ //
    $(document).on("click", ".remove-row", function () {
        $(this).closest("tr").remove();
        renumberRows();
        updateSummary();
    });

    // ------------------ Payment Type Logic ------------------ //
    $('#payment_type').on('change', function () {
        if ($(this).val() === 'Bank') {
            $('#bank_account_group').show();
        } else {
            $('#bank_account_group').hide();
            $('#bank_account').val('');
        }
    });

    // ------------------ Form Submit ------------------ //
    $("#saleForm").submit(function (e) {
        e.preventDefault();

        if (!$("#customer_id").val()) {
            alert("Please select a customer before submitting.");
            return;
        }

        let items = [];
        $("#table_items tbody tr").each(function () {
            items.push({
                item_name: $(this).find('.item').val() || '',
                description: $(this).find('.description').val() || '',
                qty: parseFloat($(this).find('.qty').val()) || 0,
                amount: parseFloat($(this).find('.amount').val()) || 0,
                tax_percent: parseFloat($(this).find('.tax').val()) || 0,
                tax_amt: parseFloat($(this).find('.tax-amt').val()) || 0
            });
        });

        let formData = $(this).serializeArray();
        let data = {};
        formData.forEach(function(item){ data[item.name] = item.value; });
        data['items'] = JSON.stringify(items);
        data['total_amount'] = $('#total_amount').val();
        data['total_tax'] = $('#total_tax').val();
        data['grand_total'] = $('#grand_total').val();
        data['amount_paid'] = $('#amount_paid').val();
        data['payment_type'] = $('#payment_type').val();
        data['bank_account'] = $('#bank_account').val();
        data['amount_paid'] = $('#amount_paid').val();

        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: data,
            headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
            success: function(response) {
                // Check if response contains redirect URL
                if (response.redirect_url) {
                    window.location.href = response.redirect_url;
                } else {
                    alert('Service Bill Saved!');
                    window.location.reload();
                }
            },
            error: function() {
                alert('Server error.');
            }
        });
    });
});
</script>

{% endblock javascripts %}
