<style>
    #table_items input.form-control, #table_items textarea.form-control {
        min-width: 140px;
        width: 100%;
        box-sizing: border-box;
    }
    @media (max-width: 768px) {
        #table_items th, #table_items td {
            font-size: 13px;
            padding: 4px;
        }
        #table_items input.form-control, #table_items textarea.form-control {
            min-width: 80px;
        }
        .table-responsive {
            margin-bottom: 1rem;
        }
    }
    .table-responsive {
        overflow-x: auto;
        width: 100%;
    }
</style>
{% extends "store/base.html" %}
{% load static %}

{% block title %}Service Billing{% endblock title %}

{% block stylesheets %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ttskch/select2-bootstrap4-theme@1.5.2/dist/select2-bootstrap4.min.css">
{% endblock stylesheets %}

{% block content %}
<div class="container mt-4">
    <h3 class="mb-4">Service Billing</h3>
        
<!-- Sale Form -->


    <form id="saleForm" action="{% url 'servicebill_create' %}" method="post">
        {% csrf_token %}
        
        <!-- Customer -->
        <div class="form-group mb-3">
            <label for="customer_searchbox" class="form-label">Customer Name</label>
            <input type="text" id="customer_searchbox" class="form-control" placeholder="Type Customer Name / Phone ... " autocomplete="off">
            <div id="customer_suggestions" class="form-label" style="z-index: 1000;"></div>
            <input type="hidden" name="customer_id" id="customer_id">  <!-- Hidden field to submit ID -->
        </div>

        <!-- Sale Items -->
        <div class="table-responsive">
            <table id="table_items" class="table table-bordered">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Item</th>
                        <th>Description</th>
                        <th>Qty</th>
                        <th>Rate</th>
                        <th>Amount</th>
                        <th>Tax %</th>
                        <th>Tax Amt</th>
                        <th>Total</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <button type="button" class="btn btn-primary mb-3" id="addRowBtn">Add Row</button>

        <!-- Summary -->
        <div class="row">
            <div class="col-md-4 offset-md-8">
                <div class="form-group">
                    <label>Total Amount</label>
                    <input type="text" id="total_amount" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Total Tax</label>
                    <input type="text" id="total_tax" class="form-control" readonly>
                </div>
                <div class="form-group">
                    <label>Grand Total</label>
                    <input type="text" id="grand_total" class="form-control" readonly>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-success">Submit Sale</button>
    </form>
</div>

<!-- Customer Create Modal -->
<div class="modal fade" id="customerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form id="createCustomerForm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Create New Customer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="text" name="first_name" class="form-control" placeholder="Enter First Name"><br>
                    <input type="text" name="last_name" class="form-control" placeholder="Enter Last Name"><br>
                    <input type="number" name="phone" class="form-control" placeholder="Enter Phone Number">
                    <!-- Add other fields as needed -->
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Create</button>
                </div>
            </div>
        </form>
    </div>
</div>

{% endblock content %}

{% block javascripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Include Select2 CSS and JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Bootstrap Bundle with Popper.js -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Explicitly initializing Bootstrap dropdowns if needed
    document.querySelectorAll('.dropdown-toggle').forEach(function (element) {
        new bootstrap.Dropdown(element);
    });
</script>

<script>
$(document).ready(function () {
    let rowIndex = 0;

    // ------------------ Customer Search + Create ------------------ //
    function customerSearchSuggestions() {
        const searchBox = $("#customer_searchbox");
        const suggestionsBox = $("#customer_suggestions");
        const hiddenField = $("#customer_id");
        const customerModal = new bootstrap.Modal(document.getElementById('customerModal'));

        searchBox.on("input", function () {
            const query = $(this).val();
            if (query.length >= 2) {
                fetch(`/search-customer/?q=${query}`)
                    .then(response => response.json())
                    .then(data => {
                        suggestionsBox.empty();
                        if (data.results && data.results.length > 0) {
                            data.results.forEach(suggestion => {
                                const item = $(`<a href="javascript:void(0);" class="list-group-item list-group-item-action">${suggestion.text}</a>`);
                                item.on("click", function () {
                                    searchBox.val(suggestion.text);
                                    hiddenField.val(suggestion.id);
                                    suggestionsBox.empty();
                                });
                                suggestionsBox.append(item);
                            });
                        } else {
                            const noItem = $(`<a class="list-group-item list-group-item-action text-danger" style="cursor:pointer;">No customer found. Click to add.</a>`);
                            noItem.on("click", function () {
                                customerModal.show();
                                const names = query.split(" ");
                                $("#customerModal input[name='first_name']").val(names[0] || "");
                                $("#customerModal input[name='last_name']").val(names.slice(1).join(" ") || "");
                            });
                            suggestionsBox.append(noItem);
                        }
                    })
                    .catch(err => console.error("Error fetching customer suggestions:", err));
            } else {
                suggestionsBox.empty();
                hiddenField.val("");
            }
        });

        // Handle new customer create (AJAX)
        $("#createCustomerForm").on("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const csrfToken = $("[name=csrfmiddlewaretoken]").val();

            fetch("{% url 'create_customer_ajax' %}", {
                method: "POST",
                headers: { "X-CSRFToken": csrfToken },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    searchBox.val(data.customer.full_name);
                    hiddenField.val(data.customer.id);
                    customerModal.hide();
                    this.reset();
                    suggestionsBox.empty();
                    alert("Customer created successfully!");
                } else {
                    alert(data.error || "Error creating customer");
                }
            })
            .catch(error => {
                console.error("Error:", error);
                alert("Error creating customer");
            });
        });
    }
    customerSearchSuggestions();

    // ------------------ Add Row ------------------ //
    $("#addRowBtn").click(function () {
        rowIndex++;
        $("#table_items tbody").append(`
            <tr>
                <td class="row-number"></td>
                <td><input type="text" name="items[][item_name]" class="form-control item"></td>
                <td><textarea name="items[][description]" class="form-control description"></textarea></td>
                <td><input type="text" name="items[][qty]" class="form-control qty" value="1" min="1"></td>
                <td><input type="text" name="items[][rate]" class="form-control rate" value="0"></td>
                <td><input type="text" class="form-control amount" readonly></td>
                <td><input type="text" name="items[][tax]" class="form-control tax" value="0"></td>
                <td><input type="text" class="form-control tax-amt" readonly></td>
                <td><input type="text" class="form-control total" readonly></td>
                <td><button type="button" class="btn btn-danger btn-sm remove-row"><i class="fa fa-trash"></i></button></td>
            </tr>
        `);
        renumberRows();
    });

    // ------------------ Renumber Rows ------------------ //
    function renumberRows() {
        $("#table_items tbody tr").each(function (index) {
            $(this).find(".row-number").text(index + 1);
        });
    }

    // ------------------ Update Totals ------------------ //
    function updateSummary() {
        let totalAmount = 0, totalTax = 0, grandTotal = 0;
        $("#table_items tbody tr").each(function () {
            const qty = parseFloat($(this).find(".qty").val()) || 0;
            const rate = parseFloat($(this).find(".rate").val()) || 0;
            const taxPerc = parseFloat($(this).find(".tax").val()) || 0;

            const amount = qty * rate;
            const taxAmt = (amount * taxPerc) / 100;
            const total = amount + taxAmt;

            $(this).find(".amount").val(amount.toFixed(2));
            $(this).find(".tax-amt").val(taxAmt.toFixed(2));
            $(this).find(".total").val(total.toFixed(2));

            totalAmount += amount;
            totalTax += taxAmt;
            grandTotal += total;
        });
        $("#total_amount").val(totalAmount.toFixed(2));
        $("#total_tax").val(totalTax.toFixed(2));
        $("#grand_total").val(grandTotal.toFixed(2));
    }
    $(document).on("input", ".qty, .rate, .tax", updateSummary);

    // ------------------ Remove Row ------------------ //
    $(document).on("click", ".remove-row", function () {
        $(this).closest("tr").remove();
        renumberRows();
        updateSummary();
    });

    // ------------------ Form Submit ------------------ //
    $("#saleForm").submit(function (e) {
        e.preventDefault();

        if (!$("#customer_id").val()) {
            alert("Please select a customer before submitting.");
            return;
        }

        let items = [];
        $("#table_items tbody tr").each(function () {
            items.push({
                item_name: $(this).find('.item').val() || '',
                description: $(this).find('.description').val() || '',
                qty: parseFloat($(this).find('.qty').val()) || 0,
                rate: parseFloat($(this).find('.rate').val()) || 0,
                amount: parseFloat($(this).find('.amount').val()) || 0,
                tax_percent: parseFloat($(this).find('.tax').val()) || 0,
                tax_amt: parseFloat($(this).find('.tax-amt').val()) || 0,
                total: parseFloat($(this).find('.total').val()) || 0
            });
        });

        let formData = $(this).serializeArray();
        let data = {};
        formData.forEach(function(item){ data[item.name] = item.value; });
        data['items'] = JSON.stringify(items);
        data['total_amount'] = $('#total_amount').val();
        data['total_tax'] = $('#total_tax').val();
        data['grand_total'] = $('#grand_total').val();

        $.ajax({
            url: $(this).attr('action'),
            type: 'POST',
            data: data,
            headers: { 'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val() },
            success: function(response) {
                // Check if response contains redirect URL
                if (response.redirect_url) {
                    window.location.href = response.redirect_url;
                } else {
                    alert('Service Bill Saved!');
                    window.location.reload();
                }
            },
            error: function() {
                alert('Server error.');
            }
        });
    });
});
</script>

{% endblock javascripts %}
